---
title: "Pregnant Female Data Analysis Colorado 2022"
author: "Robin Bedard & Savannah Weaver"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages


```{r, include=FALSE}
knitr::opts_chunk$set(include = TRUE, message = FALSE, warning = FALSE)
```


```{r}
library("tidyverse") # for dplyr workflow + ggplot
library("rmdformats") # pretty Rmd format
library("lme4")
library("lmerTest")
library("emmeans")
library("broom")
library("AICcmodavg")
library("ggpubr")
```







# Load & Tidy Data


## CEWL, Osml, Mass, SVL

```{r}
mother_data_all <- read_rds("data/mother_data_all.RDS")
```


## Birthing Timeline

This dataframe includes a column "Day Relative" which is the number of days, relative to the day they gave birth, that the measurements were taken.

```{r}
day_scale <- read_csv("data/day_relative_to_birth.csv")

day_scale_clean <- day_scale %>%
  mutate(IndivID = as.factor(str_trim(IndivID)),
         CEWLBloodCollectDate = as.Date(str_trim(CEWLBloodCollectDate),
                                         format = "%m/%d/%y"),
         DayRelativeToZero = as.numeric(DayRelativeToZero)
  ) %>%
  #rename all column names 
  dplyr::select(Indiv_ID = IndivID, 
                CEWL_Blood_Collect_Date = CEWLBloodCollectDate,
                Day_Relative = DayRelativeToZero) %>%
  fill(Indiv_ID)
```

## Tmt Timeline

First, uploading the CSV with the new column of days relative to number of days in hydration treatment.

```{r}
days_in_tmt <- read_csv("data/days_in_tmt.csv")

days_in_tmt_clean <- days_in_tmt %>%
  mutate(IndivID = as.factor(str_trim(IndivID)),
         CEWLBloodCollectDate = as.Date(str_trim(CEWLBloodCollectDate),
                                         format = "%m/%d/%y"),
         DaysInTrmt = as.numeric(DaysInTrmt),
         GaveBirth = as.factor(GaveBirth)
  ) %>%
  #rename all column names 
  dplyr::select(Indiv_ID = IndivID, 
                CEWL_Blood_Collect_Date = CEWLBloodCollectDate,
                Days_in_Treatment = DaysInTrmt, 
                Gave_Birth = GaveBirth)  %>%
  fill(Indiv_ID)
```



## Offspring


```{r}
neo_counts <- read_csv("data/neonate_count.csv", 
                       col_types = "fddd") %>% 
  mutate(
    total_embryos = (live_neonates+dead_at_birth+slugs),
    prop_live = live_neonates/total_embryos
  )
```





## Merge Dataframes


```{r}
mother_data_all_final_full <- mother_data_all %>% 
  left_join(day_scale_clean, 
            by = c("Indiv_ID", "CEWL_Blood_Collect_Date")) %>% 
  left_join(days_in_tmt_clean, 
            by = c("Indiv_ID", "CEWL_Blood_Collect_Date")) %>% 
  mutate(Hydration_Trmt = factor(Hydration_Trmt)) 

summary(mother_data_all_final_full)

mother_data_all_final_full %>% 
  group_by(Indiv_ID) %>% 
  count() %>% 
  #filter(n == 4)
  summary()
  
mother_data_all_final_full %>% 
  filter(Indiv_ID %in% c(103, 115))
```






## Sub-dfs

First, making a dataframe with the snakes that did give birth. 

```{r}
birth_snakes <- mother_data_all_final_full %>%
  filter(Gave_Birth == "Y") %>% 
  # Robin removes this snake, but I don't remember why
  filter(Indiv_ID != 117) %>% 
  left_join(neo_counts, by = c("Indiv_ID" = "Mother_ID"))

birth_snakes_DAB <- birth_snakes %>% 
  filter(Preg_Stage == "DAB") %>% 
  select(
    Mother_ID = Indiv_ID,
    Mother_CEWL = CEWL_g_m2h,
    Mother_mass = Mass_g,
    Mother_SVL = SVL_cm,
    Mother_osml = Plasma_Osmol_Rep_mean,
    Mother_Days_in_Treatment = Days_in_Treatment
  )
write_rds(birth_snakes_DAB, "./data/mother_values.RDS")
```

Now, a dataframe with the snakes that did not give birth.

```{r}
no_birth_snakes <- mother_data_all_final_full %>%
  filter(Gave_Birth == "N")
```

At capture measurements... I need a dataframe with only the baseline measurements. 

```{r}
mothers_baseline <- mother_data_all_final_full %>%
  filter(Preg_Stage == "DAC") #DAC= day after capture
```







# Exp Info

```{r}
birth_snakes %>% 
  group_by(Indiv_ID) %>% 
  summarise(
    min_date = min(CEWL_Blood_Collect_Date),
    max_date = max(CEWL_Blood_Collect_Date)
  ) %>% 
  mutate(range = max_date - min_date) %>% 
  arrange(range)
no_birth_snakes %>% 
  group_by(Indiv_ID) %>% 
  summarise(
    min_date = min(CEWL_Blood_Collect_Date),
    max_date = max(CEWL_Blood_Collect_Date)
  ) %>% 
  mutate(range = max_date - min_date) %>% 
  arrange(range)

mother_data_all_final_full %>% 
  summarise(
    min_date = min(CEWL_Blood_Collect_Date),
    max_date = max(CEWL_Blood_Collect_Date)
  ) %>% 
  mutate(range = max_date - min_date)
```














# BASELINE CEWL (at capture)
*add VPD*

```{r}
baseline_cewl_1 <- lme4::lmer(data = mothers_baseline,
                      CEWL_g_m2h ~
                        Tb_at_CEWL +
                        msmt_temp_C +
                        msmt_RH_percent +
                        Mass_g +
                        SVL_cm +
                        (1|CEWL_Blood_Collect_Date))
                    
car::vif(baseline_cewl_1)
drop1(baseline_cewl_1)
anova(baseline_cewl_1)
```


```{r}
baseline_cewl_2 <- lme4::lmer(data = mothers_baseline,
                      CEWL_g_m2h ~
                        Tb_at_CEWL +
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|CEWL_Blood_Collect_Date))
                    
drop1(baseline_cewl_2)
anova(baseline_cewl_2)
```


```{r}
baseline_cewl_3 <- lme4::lmer(data = mothers_baseline,
                      CEWL_g_m2h ~
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|CEWL_Blood_Collect_Date))
                    
drop1(baseline_cewl_3)
anova(baseline_cewl_3)
```


```{r}
baseline_cewl_4 <- lme4::lmer(data = mothers_baseline,
                      CEWL_g_m2h ~
                        msmt_RH_percent +
                        (1|CEWL_Blood_Collect_Date))
```


```{r}
baseline_cewl_null <- lme4::lmer(data = mothers_baseline,
                      CEWL_g_m2h ~ 1 +
                        (1|CEWL_Blood_Collect_Date))
```


## Model selection


```{r}
baseline_cewl_mods <- list(baseline_cewl_1, baseline_cewl_2, 
                           baseline_cewl_3, baseline_cewl_4,
                           baseline_cewl_null)

#specify model names
baeline_cewl_mod_names_all <- c('model1', 
                    'model2',
                    'model3',
                    'model4',
                    'modelnull')

#calculate AIC of each model
cewl_AICc_all <- data.frame(aictab(cand.set = baseline_cewl_mods, 
                                 modnames = baeline_cewl_mod_names_all))
cewl_AICc_all
```




## Final model

Best model was 3 which included:

```{r}
baseline_final_mod <- lmerTest::lmer(data = mothers_baseline,
                      CEWL_g_m2h ~
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|CEWL_Blood_Collect_Date))

summary(baseline_final_mod)
anova(baseline_final_mod)
```










# EXPERIMENTAL CEWL


## Birthing timeline?
*add VPD*

```{r}
CEWL_LMM_birth <- lme4::lmer(data = birth_snakes,
                      CEWL_g_m2h ~
                        Hydration_Trmt *
                        Days_in_Treatment +
                        Day_Relative +
                        Tb_at_CEWL +
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|Indiv_ID))

car::Anova(CEWL_LMM_birth, test = "F", type = "2")
```


Since day relative to birth is not significant, I can include all snakes in one model together. 

```{r}
CEWL_LMM_1 <- lme4::lmer(data = mother_data_all_final_full,
                      CEWL_g_m2h ~
                        Hydration_Trmt *
                        Days_in_Treatment +
                        Day_Relative +
                        Tb_at_CEWL +
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|Indiv_ID))

car::vif(CEWL_LMM_1)
drop1(CEWL_LMM_1)
car::Anova(CEWL_LMM_1, test = "F", type = "2")
```


```{r}
CEWL_LMM_2 <- lme4::lmer(data = mother_data_all_final_full,
                      CEWL_g_m2h ~
                        Hydration_Trmt +
                        Days_in_Treatment +
                        Tb_at_CEWL +
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|Indiv_ID))
drop1(CEWL_LMM_2)
anova(CEWL_LMM_2)
```


```{r}
CEWL_LMM_3 <- lme4::lmer(data = mother_data_all_final_full,
                      CEWL_g_m2h ~
                        Hydration_Trmt +
                        Days_in_Treatment +
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|Indiv_ID))

drop1(CEWL_LMM_3)
anova(CEWL_LMM_3)
```

```{r}
CEWL_LMM_4 <- lme4::lmer(data = mother_data_all_final_full,
                      CEWL_g_m2h ~
                        Hydration_Trmt +
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|Indiv_ID))

drop1(CEWL_LMM_4)
anova(CEWL_LMM_4)
```


```{r}
CEWL_LMM_5 <- lme4::lmer(data = mother_data_all_final_full,
                      CEWL_g_m2h ~
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|Indiv_ID))

drop1(CEWL_LMM_5)
anova(CEWL_LMM_5)
```


```{r}
CEWL_LMM_6 <- lme4::lmer(data = mother_data_all_final_full,
                      CEWL_g_m2h ~
                        msmt_RH_percent +
                        (1|Indiv_ID))
```



```{r}
CEWL_LMM_null <- lme4::lmer(data = mother_data_all_final_full,
                      CEWL_g_m2h ~ 1 +
                        (1|Indiv_ID))
```


## Model selection

```{r}
cewl_models_all <- list(CEWL_LMM_1, 
                        CEWL_LMM_2, 
                        CEWL_LMM_3, 
                        CEWL_LMM_4, 
                        CEWL_LMM_5, 
                        CEWL_LMM_6, 
                        CEWL_LMM_null)

#specify model names
cewl_mod_names_all <- c('model1', 
                    'model2', 
                    'model3',
                    'model4',
                    'model5',
                    'model6',
                    'modelnull')

#calculate AIC of each model
cewl_AICc_all <- data.frame(aictab(cand.set = cewl_models_all, 
                                 modnames = cewl_mod_names_all))
cewl_AICc_all
```



## Final model

The best model is model 4.

```{r}
CEWL_LMM_best <- lmerTest::lmer(data = mother_data_all_final_full,
                      CEWL_g_m2h ~
                        Hydration_Trmt +
                        msmt_temp_C +
                        msmt_RH_percent +
                        (1|Indiv_ID))

summary(CEWL_LMM_best)
anova(CEWL_LMM_best, type = "3", ddf = "Kenward-Roger")
```



## Model assumptions

```{r}
plot(CEWL_LMM_best)
shapiro.test(residuals(CEWL_LMM_best))
```












# BASELINE OSMOL

check whether proximity to birthing date affected osmol:

```{r}
mothers_baseline_birthsnakes <- mothers_baseline %>%
  filter(Gave_Birth == "Y")

partur <- lm(data = mothers_baseline_birthsnakes, 
             Plasma_Osmol_Rep_mean ~ Day_Relative)

summary(partur)
anova(partur)
```
Day relative to birth was not significant. Will run all individuals in one model. 


```{r}
baseline_osmol_1 <- lme4::lmer(data = mothers_baseline,
                      Plasma_Osmol_Rep_mean ~
                        Mass_g +
                        SVL_cm +
                        (1|CEWL_Blood_Collect_Date))
                    
summary(baseline_osmol_1)
drop1(baseline_osmol_1)
anova(baseline_osmol_1)

TukeyHSD(aov(data = mothers_baseline, formula = Plasma_Osmol_Rep_mean ~ Rookery_Capture_ID))
```
The capture date didn't account for any of the variance so first dropping the random effect.

```{r}
baseline_osmol_2 <- lm(data = mothers_baseline,
                      Plasma_Osmol_Rep_mean ~
                        Mass_g +
                        SVL_cm)
                    
drop1(baseline_osmol_2)
anova(baseline_osmol_2)
```


```{r}
baseline_osmol_3 <- lm(data = mothers_baseline,
                      Plasma_Osmol_Rep_mean ~
                        SVL_cm)
                    
anova(baseline_osmol_3)
```




```{r}
baseline_osmol_null <- lm(data = mothers_baseline,
                      Plasma_Osmol_Rep_mean ~ 1)
```

## Model selection

```{r}
baseline_osmol_mods <- list(baseline_osmol_2, 
                            baseline_osmol_3, 
                            baseline_osmol_null)

#specify model names
baeline_osmol_mod_names_all <- c('model2', 'model3', 'modelnull')

#calculate AIC of each model
cewl_AICc_all <- data.frame(aictab(cand.set = baseline_osmol_mods, 
                                 modnames = baeline_osmol_mod_names_all))
cewl_AICc_all
```

They are all equivalent.


## No Final Model

****Remember that birthing effecting osmolality, so we created two separate models for the snakes that gave birth and those that didn't. See both below. 








# EXP OSMOL - BIRTH MOTHERS

```{r}
BirthSnakes_LMM_0 <- lme4::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt *
                        (Days_in_Treatment + live_neonates) +
                        Day_Relative +
                        Mass_g +
                        SVL_cm +
                        (1|Indiv_ID))

car::vif(BirthSnakes_LMM_0)
```


```{r}
BirthSnakes_LMM_0.1 <- lme4::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt *
                        Days_in_Treatment + 
                        live_neonates +
                        Day_Relative +
                        Mass_g +
                        SVL_cm +
                        (1|Indiv_ID))

car::vif(BirthSnakes_LMM_0.1)
drop1(BirthSnakes_LMM_0.1)
anova(BirthSnakes_LMM_0.1)
```


```{r}
BirthSnakes_LMM_1 <- lme4::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt *
                        Days_in_Treatment + 
                        Day_Relative +
                        Mass_g +
                        SVL_cm +
                        (1|Indiv_ID))

drop1(BirthSnakes_LMM_1)
anova(BirthSnakes_LMM_1)
```


```{r}
BirthSnakes_LMM_2a <- lme4::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt *
                        Days_in_Treatment +
                        Day_Relative +
                        SVL_cm +
                        (1|Indiv_ID))

drop1(BirthSnakes_LMM_2a)
anova(BirthSnakes_LMM_2a)

BirthSnakes_LMM_2 <- lme4::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt *
                        Days_in_Treatment +
                        Day_Relative +
                        (1|Indiv_ID))

drop1(BirthSnakes_LMM_2)
anova(BirthSnakes_LMM_2)
```


```{r}
BirthSnakes_LMM_3 <- lme4::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt *
                        Days_in_Treatment +
                        (1|Indiv_ID))

drop1(BirthSnakes_LMM_3)
anova(BirthSnakes_LMM_3)
```

```{r}
BirthSnakes_LMM_4 <- lme4::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt + 
                        Days_in_Treatment +
                        (1|Indiv_ID))

drop1(BirthSnakes_LMM_4)
anova(BirthSnakes_LMM_4)
```


```{r}
BirthSnakes_LMM_5 <- lme4::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Days_in_Treatment +
                        (1|Indiv_ID))

anova(BirthSnakes_LMM_5)
```


```{r}
BirthSnakes_LMM_null<- lme4::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~ 1 +
                        (1|Indiv_ID))
```



## Model selection

```{r}
osmolarity_models <- list(BirthSnakes_LMM_1, BirthSnakes_LMM_2, 
                          BirthSnakes_LMM_3, BirthSnakes_LMM_4, 
                          BirthSnakes_LMM_5, BirthSnakes_LMM_null)

#specify model names
osmolarity_mod_names <- c('model1', 
                    'model2', 
                    'model3',
                    'model4',
                    'model5',
                    'modelnull')

#calculate AIC of each model
osmolarity_AICc <- data.frame(aictab(cand.set = osmolarity_models, 
                                 modnames = osmolarity_mod_names))
osmolarity_AICc
```


## Final model


```{r}
BirthSnakes_LMM_best <- lmerTest::lmer(data = birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt *
                        Days_in_Treatment +
                        Day_Relative +
                        (1|Indiv_ID))

summary(BirthSnakes_LMM_best)
anova(BirthSnakes_LMM_best)
emtrends(BirthSnakes_LMM_best, 
         "Hydration_Trmt", var = "Days_in_Treatment")
pairs(emtrends(BirthSnakes_LMM_2, 
               "Hydration_Trmt", var = "Days_in_Treatment"))
```


## Model assumptions


```{r}
plot(BirthSnakes_LMM_best)
shapiro.test(residuals(BirthSnakes_LMM_2))
```







# EXP OSMOL - NO BIRTH

```{r}
No_BirthSnakes_LMM_1 <- lme4::lmer(data = no_birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt *
                        Days_in_Treatment +
                        (1|Indiv_ID))

drop1(No_BirthSnakes_LMM_1)
anova(No_BirthSnakes_LMM_1)
```


```{r}
No_BirthSnakes_LMM_2 <- lme4::lmer(data = no_birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt +
                        Days_in_Treatment +
                        (1|Indiv_ID))

drop1(No_BirthSnakes_LMM_2)
anova(No_BirthSnakes_LMM_2)
```


```{r}
No_BirthSnakes_LMM_3 <- lme4::lmer(data = no_birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt +
                        (1|Indiv_ID))
summary(No_BirthSnakes_LMM_3) # raneff no longer explains any variation
```


```{r}
No_BirthSnakes_LMM_null <- lme4::lmer(data = no_birth_snakes,
                      Plasma_Osmol_Rep_mean ~ 1 +
                        (1|Indiv_ID))
```

## Model selection

```{r}
osmolarity_models_nb <- list(No_BirthSnakes_LMM_1, 
                          No_BirthSnakes_LMM_2, 
                          No_BirthSnakes_LMM_3, 
                          No_BirthSnakes_LMM_null)

#specify model names
osmolarity_mod_names_nb <- c('model1', 
                    'model2', 
                    'model3',
                    'modelnull')

#calculate AIC of each model
osmolarity_AICc_nb <- data.frame(aictab(cand.set = osmolarity_models_nb, 
                                 modnames = osmolarity_mod_names_nb))
osmolarity_AICc_nb
```




## Final model
Best model is 1


```{r}
No_BirthSnakes_LMM_best <- lmerTest::lmer(data = no_birth_snakes,
                      Plasma_Osmol_Rep_mean ~
                        Hydration_Trmt *
                        Days_in_Treatment +
                        (1|Indiv_ID))

summary(No_BirthSnakes_LMM_1)
anova(No_BirthSnakes_LMM_1)
emtrends(No_BirthSnakes_LMM_1, 
         "Hydration_Trmt", var = "Days_in_Treatment")
pairs(emtrends(No_BirthSnakes_LMM_1, 
               "Hydration_Trmt", var = "Days_in_Treatment"))
```


## Model assumptions

```{r}
plot(No_BirthSnakes_LMM_best)
shapiro.test(residuals(No_BirthSnakes_LMM_best))
```









# CEWL vs Osmolarity 


## All values

```{r}
cewl_osmol_lm <- lm(data = mother_data_all_final_full,
                    CEWL_g_m2h ~ Plasma_Osmol_Rep_mean)
summary(cewl_osmol_lm)

cewl_osmol_lm_2 <- lm(data = mother_data_all_final_full,
                    Plasma_Osmol_Rep_mean ~ CEWL_g_m2h)
summary(cewl_osmol_lm_2)
```


## Split by timing 

```{r}
mothers_DAC <- mother_data_all_final_full %>%
  filter(Preg_Stage == "DAC")

mothers_DAB <- mother_data_all_final_full %>%
  filter(Preg_Stage == "DAB")

mothers_1WAC <- mother_data_all_final_full %>%
  filter(Preg_Stage == "1WAC")
```


## Day after capture

```{r}
dac_lm <- lm(data = mothers_DAC, CEWL_g_m2h ~ Plasma_Osmol_Rep_mean)
summary(dac_lm)
anova(dac_lm)
```





## Day after birth

```{r}
dab_lm <- lm(data = mothers_DAB, CEWL_g_m2h ~ Plasma_Osmol_Rep_mean)
summary(dab_lm)
anova(dab_lm)
```

















# TMT EFFECTS

Use a subset of data to examine only the effect of supplemental hydration: compare maternal plasma osmolality, CEWL, and body mass recorded the day after capture versus measurements taken after one week in treatment.

Run LMM with individual ID as a random effect (2 obs per ind), followed by pairwise comparisons.

If a female gave birth within one week of capture, we used her at-birth measurements.


## Prep Data

```{r}
# mothers with 1wac msmts
have_1wac <- mother_data_all_final_full %>% 
  filter(Preg_Stage == "1WAC")
# mothers that did not have a 1wac msmt bc gave birth before then
missing_1wac <- mother_data_all_final_full %>% 
  filter(!(Indiv_ID %in% have_1wac$Indiv_ID))

# 20 indivuals with dac vs 1wac comparison
dacwac <- mother_data_all_final_full %>% 
  filter(Indiv_ID %in% have_1wac$Indiv_ID) %>% 
  filter(Preg_Stage %in% c("DAC", "1WAC"))

# 9 individuals with dac vs dab comparison
dacdab <- mother_data_all_final_full %>% 
  filter(Indiv_ID %in% missing_1wac$Indiv_ID) %>% 
  filter(Preg_Stage %in% c("DAC", "DAB"))

# both comparisons
tmt_befaft <- rbind(dacdab, dacwac) %>% 
  mutate(Preg_Stage = factor(Preg_Stage),
         tmt_timing = factor(case_when(Preg_Stage == "DAC" ~ "Before",
                                Preg_Stage == "DAB" ~ "After",
                                Preg_Stage == "1WAC" ~ "After"),
                             levels = c("Before", "After")))
summary(tmt_befaft)

# check all individuals have 2 values
tmt_befaft %>% 
  group_by(Indiv_ID) %>% 
  count()

# check time in tmt
tmt_befaft %>% 
  group_by(Indiv_ID) %>% 
  summarise(
    min_date = min(CEWL_Blood_Collect_Date),
    max_date = max(CEWL_Blood_Collect_Date)
  ) %>% 
  mutate(range = as.numeric(max_date - min_date)) %>% 
  summary()
```


```{r}
# changes in vars
deltas_raw <- tmt_befaft %>%
  arrange(Indiv_ID, CEWL_Blood_Collect_Date) %>% 
  group_by(Indiv_ID) %>%
  mutate(
    delta_mass = Mass_g - lag(Mass_g),
    delta_osml = Plasma_Osmol_Rep_mean - lag(Plasma_Osmol_Rep_mean),
    delta_CEWL = CEWL_g_m2h - lag(CEWL_g_m2h)
  ) 

deltas_befaft <- deltas_raw %>% 
  ungroup() %>% 
  mutate(
    delta_mass = case_when(is.na(delta_mass) ~ 0, TRUE ~ delta_mass),
    delta_osml = case_when(is.na(delta_osml) ~ 0, TRUE ~ delta_osml),
    delta_CEWL = case_when(is.na(delta_CEWL) ~ 0, TRUE ~ delta_CEWL)
  )

deltas <- deltas_raw %>%
  filter(complete.cases(delta_mass))

summary(deltas)
```




only use mass for the snakes that did not give birth in the first week of the experiment:

```{r}
deltas_mass_only <- deltas %>% 
  filter(Preg_Stage == "1WAC")
deltas_befaft_mass_only <- deltas_befaft %>% 
  filter(Indiv_ID %in% deltas_mass_only$Indiv_ID)
tmt_befaft_mass_only <- tmt_befaft %>% 
  filter(Indiv_ID %in% deltas_mass_only$Indiv_ID)
```




## MASS 



```{r}
mass_lm_time_tmt <- lmerTest::lmer(data = tmt_befaft_mass_only, 
            Mass_g ~ tmt_timing * Hydration_Trmt + (1|Indiv_ID))

mass_means_time <- emmeans(mass_lm_time_tmt, 
                       pairwise ~ tmt_timing | Hydration_Trmt)
mass_means_time$contrasts

mass_means_tmt <- emmeans(mass_lm_time_tmt, 
                       pairwise ~ Hydration_Trmt | tmt_timing)
mass_means_tmt$contrasts

mass_means <- emmeans(mass_lm_time_tmt, "Hydration_Trmt", by = "tmt_timing")
mass_lm_time_tmt_CI <- tidy(confint(mass_means))
#mass_lm_time_tmt_CI <- tidy(mass_means_time$emmeans) # either would work

anova(mass_lm_time_tmt)
```




## MASS CHANGE

```{r}
delta_mass_lm <- lm(data = deltas_mass_only, delta_mass ~ Hydration_Trmt)

summary(delta_mass_lm)
anova(delta_mass_lm)
emmeans(delta_mass_lm, pairwise ~ Hydration_Trmt)
```















## OSMOLALITY


```{r}
osml_lm_time_tmt <- lmerTest::lmer(data = tmt_befaft, 
    Plasma_Osmol_Rep_mean ~ tmt_timing * Hydration_Trmt + (1|Indiv_ID))

osml_means_time <- emmeans(osml_lm_time_tmt, 
                       pairwise ~ tmt_timing | Hydration_Trmt)
osml_means_time$contrasts

osml_means_tmt <- emmeans(osml_lm_time_tmt, 
                       pairwise ~ Hydration_Trmt | tmt_timing)
osml_means_tmt$contrasts

osml_means <- emmeans(osml_lm_time_tmt, "Hydration_Trmt", by = "tmt_timing")
osml_lm_time_tmt_CI <- tidy(confint(osml_means))

anova(osml_lm_time_tmt)
```






## OSMOL CHANGE

```{r}
delta_osml_lm <- lm(data = deltas, delta_osml ~ Hydration_Trmt)

summary(delta_osml_lm)
anova(delta_osml_lm)
emmeans(delta_osml_lm, pairwise ~ Hydration_Trmt)
```















## CEWL 


```{r}
cewl_lm_time_tmt <- lmerTest::lmer(data = tmt_befaft, 
          CEWL_g_m2h ~ tmt_timing * Hydration_Trmt + (1|Indiv_ID))

cewl_means_time <- emmeans(cewl_lm_time_tmt, 
                       pairwise ~ tmt_timing | Hydration_Trmt)
cewl_means_time$contrasts

cewl_means_tmt <- emmeans(cewl_lm_time_tmt, 
                       pairwise ~ Hydration_Trmt | tmt_timing)
cewl_means_tmt$contrasts

cewl_means <- emmeans(cewl_lm_time_tmt, "Hydration_Trmt", by = "tmt_timing")
cewl_lm_time_tmt_CI <- tidy(confint(cewl_means))
#cewl_lm_time_tmt_CI <- tidy(cewl_means_time$emmean)

anova(cewl_lm_time_tmt)
```






## CEWL CHANGE

```{r}
delta_cewl_lm <- lm(data = deltas, delta_CEWL ~ Hydration_Trmt)

summary(delta_cewl_lm)
anova(delta_cewl_lm)
emmeans(delta_cewl_lm, pairwise ~ Hydration_Trmt)
```


































# Figure Formatting

```{r}
my_ggplot_theme <- theme_classic() + # start with a preset theme to make things easy
                     theme(axis.title = element_text(size = 10), # text size for axis labels
                           axis.text = element_text(size = 8, # text size for axis values
                                                    color = "black", # need to specifically set color
                                                    family = "sans"), # and family
                           legend.title = element_text(size = 8), # text size for the legend title
                           legend.text = element_text(size = 8), # text size for legend items
                           text = element_text(color = "black", # color for all text (except axis values)
                                               family = "sans") # family
                           )
```

Now, apply the theme. This sets the theme for the entire Rmd document.

```{r}
theme_set(my_ggplot_theme)
```











# PUBLICATION FIGURE 1


## mass raw

```{r}
ggplot() +
  geom_point(
    data = tmt_befaft_mass_only,
    aes(
    x = tmt_timing,
    y = Mass_g,
    color = Hydration_Trmt,
    shape = Hydration_Trmt
  ),
    size = 1.1, 
    alpha = 0.5, 
    position = position_jitterdodge(jitter.width = 0.6, dodge.width = 0.6)
  ) +
  geom_line(
    data = mass_lm_time_tmt_CI,
    aes(
      x = tmt_timing, y = estimate, 
      group = Hydration_Trmt, 
      color = Hydration_Trmt
    ),
    position = position_dodge(width = 0.6)
  ) +
  geom_errorbar(
    data = mass_lm_time_tmt_CI,
    aes(
      x = tmt_timing, y = estimate, 
      ymin = conf.low, ymax = conf.high, 
      group = Hydration_Trmt, 
      color = Hydration_Trmt
    ),
    width = 0.4,
    position = position_dodge(width = 0.6)
  ) +
  geom_point(
    data = mass_lm_time_tmt_CI,
    aes(
      x = tmt_timing, y = estimate, 
      group = Hydration_Trmt, 
      color = Hydration_Trmt,
      shape = Hydration_Trmt
    ),
    size = 2.5,
    position = position_dodge(width = 0.6)
  ) + 
  
  # prettys 
  scale_color_manual(
    values = c("darkgoldenrod2", "royalblue4"), 
    labels = c("C" = "Control", "W" = "Hydration"), 
    name = NULL
  ) +
  scale_shape_manual(
    values = c(15, 17), 
    labels = c("C" = "Control", "W" = "Hydration"),
    name = NULL
  ) +
  labs(
    x = NULL, 
    y = "Mass (g)", 
    color = "Treatment"
  ) +
  scale_y_continuous(
    limits = c(280, 800), 
    breaks = seq(280, 800, by = 100)
  ) + 
  
  theme(legend.position = "none") +
  
  # statistical labels
  annotate(geom = "text", x = 1, y = 745, label = "NS", size = 2) +
  annotate(geom = "text", x = 2, y = 730, label = "*", size = 6) +
  annotate(geom = "text", x = 2.5, y = 390, label = "*", size = 6, 
           color = "darkgoldenrod2") +
  annotate(geom = "text", x = 2.5, y = 490, label = "*", size = 6,
           color = "royalblue4") -> mother_mass_all # save

mother_mass_all
```




## osmol raw

```{r}
ggplot() +
  geom_point(
    data = tmt_befaft,
    aes(
    x = tmt_timing,
    y = Plasma_Osmol_Rep_mean,
    color = Hydration_Trmt,
    shape = Hydration_Trmt
  ),
    size = 1.1, 
    alpha = 0.5, 
    position = position_jitterdodge(jitter.width = 0.6, dodge.width = 0.6)
  ) +
  geom_line(
    data = osml_lm_time_tmt_CI,
    aes(
      x = tmt_timing, y = estimate, 
      group = Hydration_Trmt, 
      color = Hydration_Trmt
    ),
    position = position_dodge(width = 0.6)
  ) +
  geom_errorbar(
    data = osml_lm_time_tmt_CI,
    aes(
      x = tmt_timing, y = estimate, 
      ymin = conf.low, ymax = conf.high, 
      group = Hydration_Trmt, 
      color = Hydration_Trmt
    ),
    width = 0.4,
    position = position_dodge(width = 0.6)
  ) +
  geom_point(
    data = osml_lm_time_tmt_CI,
    aes(
      x = tmt_timing, y = estimate, 
      group = Hydration_Trmt, 
      color = Hydration_Trmt,
      shape = Hydration_Trmt
    ),
    size = 2.5,
    position = position_dodge(width = 0.6)
  ) + 
  
  # prettys 
  scale_color_manual(
    values = c("darkgoldenrod2", "royalblue4"), 
    labels = c("C" = "Control", "W" = "Hydration"), 
    name = NULL
  ) +
  scale_shape_manual(
    values = c(15, 17), 
    labels = c("C" = "Control", "W" = "Hydration"),
    name = NULL
  ) +
  labs(
    x = NULL, 
    y = expression('Osmolality (mmol '*kg^-1*')'),
    color = "Treatment"
  ) +
  scale_y_continuous(
    limits = c(280, 382), 
    breaks = seq(280, 380, by = 20)
  ) + 
  
  theme(legend.position = "none") +
  
  # statistical labels
  annotate(geom = "text", x = 1, y = 370, label = "*", size = 6) +
  annotate(geom = "text", x = 2, y = 370, label = "*", size = 6) +
  annotate(geom = "text", x = 2.5, y = 330, label = "*", size = 6, 
           color = "darkgoldenrod2") +
  annotate(geom = "text", x = 2.5, y = 310, label = "*", size = 6,
           color = "royalblue4") -> mother_osmolality_all

mother_osmolality_all
```







## cewl raw

```{r}
ggplot() +
  geom_point(
    data = tmt_befaft,
    aes(
    x = tmt_timing,
    y = CEWL_g_m2h,
    color = Hydration_Trmt,
    shape = Hydration_Trmt
  ),
    size = 1.1, 
    alpha = 0.5, 
    position = position_jitterdodge(jitter.width = 0.6, dodge.width = 0.6)
  ) +
  geom_line(
    data = cewl_lm_time_tmt_CI,
    aes(
      x = tmt_timing, y = estimate, 
      group = Hydration_Trmt, 
      color = Hydration_Trmt
    ),
    position = position_dodge(width = 0.6)
  ) +
  geom_errorbar(
    data = cewl_lm_time_tmt_CI,
    aes(
      x = tmt_timing, y = estimate, 
      ymin = conf.low, ymax = conf.high,  
      group = Hydration_Trmt, 
      color = Hydration_Trmt
    ),
    width = 0.4,
    position = position_dodge(width = 0.6)
  ) +
  geom_point(
    data = cewl_lm_time_tmt_CI,
    aes(
      x = tmt_timing, y = estimate, 
      group = Hydration_Trmt, 
      color = Hydration_Trmt,
      shape = Hydration_Trmt
    ),
    size = 2.5,
    position = position_dodge(width = 0.6)
  ) + 
  
  # prettys 
  scale_color_manual(
    values = c("darkgoldenrod2", "royalblue4"), 
    labels = c("C" = "Control", "W" = "Hydration"), 
    name = NULL
  ) +
  scale_shape_manual(
    values = c(15, 17), 
    labels = c("C" = "Control", "W" = "Hydration"),
    name = NULL
  ) +
  labs(
    x = NULL, 
    y = expression('CEWL (g '*m^-2*' '*h^-1*')'), 
    color = "Treatment"
  ) +
  scale_y_continuous(
    limits = c(9, 31), 
    breaks = seq(10, 30, by = 5)
  ) + 
  
  theme(legend.position = "none") +
  
  # statistical labels
  annotate(geom = "text", x = 1, y = 28, label = "NS", size = 2) +
  annotate(geom = "text", x = 2, y = 28, label = "NS", size = 2) +
  annotate(geom = "text", x = 2.5, y = 16, label = "//", size = 3) -> mother_cewl_all
  
mother_cewl_all
```






## change in mass

```{r}
ggplot(
  data = deltas_befaft_mass_only, 
  aes(
    x = tmt_timing,
    y = delta_mass,
    group = Indiv_ID,
    color = Hydration_Trmt,
    shape = Hydration_Trmt
  )) +
  geom_hline(yintercept = 0, linetype = 'dashed', color = "darkgray") +
  geom_point(size = 1.4, position = position_dodge(width = 0.1)) +
  geom_line(alpha = 0.4, position = position_dodge(width = 0.1)) +
  
  # prettys 
  scale_color_manual(
    values = c("darkgoldenrod2", "royalblue4"), 
    labels = c("C" = "Control", "W" = "Hydration"), 
    name = NULL
  ) +
  scale_shape_manual(
    values = c(15, 17), 
    labels = c("C" = "Control", "W" = "Hydration"),
    name = NULL
  ) +
  labs(
    x = NULL, 
    y = expression(Delta ~ 'Mass (g)'), 
    color = "Treatment"
  ) +
  scale_y_continuous(
    #limits = c(-45, 60),
    breaks = c(-45, -30, -15, 0, 15, 30, 45, 60)
  ) +
  
  theme(legend.position = "inside",
        legend.position.inside = c(0.15, 0.15),
        legend.background = element_blank()) +
  
  # labels
  annotate(geom = "text", x = 2.3, y = 30, label = "*", size = 6, 
           color = "royalblue4") +
  annotate(geom = "text", x = 2.3, y = -30, label = "*", size = 6, 
           color = "darkgoldenrod2") +
  annotate(geom = "text", x = 2, y = 60, label = "*", 
           size = 6) -> mother_change_mass
mother_change_mass
```







## change in osmol

```{r}
ggplot(
  data = deltas_befaft, 
  aes(
    x = tmt_timing,
    y = delta_osml,
    group = Indiv_ID,
    color = Hydration_Trmt,
    shape = Hydration_Trmt
  )) +
  geom_hline(yintercept = 0, linetype = 'dashed', color = "darkgray") +
  geom_point(size = 1.4, position = position_dodge(width = 0.1)) +
  geom_line(alpha = 0.4, position = position_dodge(width = 0.1)) +
  
  # prettys 
  scale_color_manual(
    values = c("darkgoldenrod2", "royalblue4"), 
    labels = c("C" = "Control", "W" = "Hydration"), 
    name = NULL
  ) +
  scale_shape_manual(
    values = c(15, 17), 
    labels = c("C" = "Control", "W" = "Hydration"),
    name = NULL
  ) +
  labs(
    x = NULL, 
    y = expression(Delta ~ 'Osmolality (mmol '*kg^-1*')'),
    color = "Treatment"
  ) +
  scale_y_continuous(
    limits = c(-60, 45),
    breaks = c(-60, -45, -30, -15, 0, 15, 30, 45)
  ) +
  
  theme(legend.position = "inside",
        legend.position.inside = c(0.25, 0.2),
        legend.background = element_blank()) +
  
  # labels
  annotate(geom = "text", x = 2.3, y = -30, label = "*", size = 6, 
           color = "royalblue4") +
  annotate(geom = "text", x = 2.3, y = 20, label = "*", size = 6, 
           color = "darkgoldenrod2") +
  annotate(geom = "text", x = 2, y = 45, label = "*", 
           size = 6) -> mother_change_osml
mother_change_osml
```



## change in cewl

```{r}
ggplot(
  data = deltas_befaft, 
  aes(
    x = tmt_timing,
    y = delta_CEWL,
    group = Indiv_ID,
    color = Hydration_Trmt,
    shape = Hydration_Trmt
  )) +
  geom_hline(yintercept = 0, linetype = 'dashed', color = "darkgray") +
  geom_point(size = 1.4, position = position_dodge(width = 0.1)) +
  geom_line(alpha = 0.4, position = position_dodge(width = 0.1)) +
  
  # prettys 
  scale_color_manual(
    values = c("darkgoldenrod2", "royalblue4"), 
    labels = c("C" = "Control", "W" = "Hydration"), 
    name = NULL
  ) +
  scale_shape_manual(
    values = c(15, 17), 
    labels = c("C" = "Control", "W" = "Hydration"),
    name = NULL
  ) +
  labs(
    x = NULL, 
    y = expression(Delta ~ 'CEWL (g '*m^-2*' '*h^-1*')'),
    color = "Treatment"
  ) +
  scale_y_continuous(
    limits = c(-17, 10),
    breaks = c(-15, -10, -5, 0, 5, 10)
  ) +
  
  theme(legend.position = "inside",
        legend.position.inside = c(0.25, 0.2),
        legend.background = element_blank()) +
  
  # labels
  annotate(geom = "text", x = 2.3, y = -5, label = "//", size = 3) +
  annotate(geom = "text", x = 2, y = 10, label = "NS", 
           size = 2) -> mother_change_cewl
mother_change_cewl
```






## arrange


```{r}
ggarrange(
  mother_mass_all, mother_change_mass,
  mother_osmolality_all, mother_change_osml,
  mother_cewl_all, mother_change_cewl,
  nrow = 3,
  ncol = 2,
  labels = c("A", "B", "C", "D", "E", "F"),
  align = "hv"
) -> mother_tmt_effects

ggsave(
  filename = "Fig1_mother_tmt_effects.pdf",
  plot = mother_tmt_effects,
  path = "./results_figures",
  device = "pdf",
  dpi = 600,
  units = "mm",
  width = 150,
  height = 180
)
```












# PUB FIGURE 2


## CEWL ~ temp


```{r}
ggplot(data = mother_data_all, 
       aes(x = msmt_temp_C, y = CEWL_g_m2h)) +
  geom_point(size = 2, 
             alpha = 0.7,
             color = "springgreen3") +
  annotate(geom = "text", 
           x = 26.5, 
           y = 10, 
           label = "p < 0.0001", 
           size = 5) +
  geom_smooth(aes(x = msmt_temp_C, y = CEWL_g_m2h),
              method = "lm", 
              se = TRUE, 
              show.legend = TRUE, 
              color = "black") +
 scale_y_continuous(limits = c(9, 30.5),
                  breaks = seq(9, 30.5, by = 3))

```




## CEWL ~ RH


```{r}
ggplot(data = mother_data_all, 
       aes(x = msmt_RH_percent, y = CEWL_g_m2h)) +
  geom_point(size = 2, 
             alpha = 0.7, 
             color = "springgreen3") +
  annotate(geom = "text", 
           x = 44, 
           y = 10, 
           label = "p < 0.0001", 
           size = 5) +
  geom_smooth(aes(x = msmt_RH_percent, y = CEWL_g_m2h),
              method = "lm", 
              se = TRUE, 
              show.legend = TRUE, 
              color = "black") +
  labs(x = "Ambient Humidity (%)", 
       y = "") +
scale_x_continuous(breaks = c(34, 36, 38, 40, 42, 44, 46, 48), limits = c(34, 48)) +
 scale_y_continuous(limits = c(9, 30.5),
                  breaks = seq(9, 30.5, by = 3))
```














