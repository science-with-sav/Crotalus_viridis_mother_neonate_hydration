---
title: "Colorado Viridis 2021 & 2022 Analysis"
author: "Robin Bedard"
date: '2022-12-01'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("PerformanceAnalytics")
library("lme4")
library("car")
library("broom")
library("AICcmodavg")
library("raster")
```


#2022 Only Below Here
Below here will be the initial data cleaning and analysis that I started to work with for just the 2022 data. 

##Uploading Data
This includes CEWL data, osmolarity data, and all measurements
```{r}
setwd("/Users/robinbedard/Desktop/Thesis/RDS_files")
all_snake_osmol_temp <- readRDS("/Users/robinbedard/Desktop/Thesis/RDS_Files/clean_all_viridis_initial_outliersremoved.RDS")

all_snake_initial <- readRDS("/Users/robinbedard/Desktop/Thesis/RDS_Files/final_all_viridis_initial.RDS")

all_snake_initial_final <- left_join(all_snake_osmol_temp, all_snake_initial, by = c("CEWL_Blood_Collect_Date", "Indiv_ID"))
#reading in CEWL data
all_data_CEWL <- readRDS("/Users/robinbedard/Desktop/Thesis/RDS_files/CEWL_data_all_clean.RDS")
#merging all together
all_snakes_final <- left_join(all_snake_initial_final, all_data_CEWL, by = c("Indiv_ID" = "individual_ID", "CEWL_Blood_Collect_Date" = "date"))
```

##Body Condition/SMI
Applying the SMI equation to the data. This equation was created on a different RMD. 
```{r}
all_snakes_final_2 <- all_snakes_final %>%
# compute SMI
  mutate(SMI = case_when(Pregnant == "Y" ~ Mass_g * ((77.55152/SVL_cm) ^ 3.098426), 
                         Pregnant != "Y" ~ Mass_g * ((78.34545/SVL_cm) ^ 3.030647),
                         is.na(Pregnant) == TRUE ~ Mass_g * ((78.34545/SVL_cm) ^ 3.030647)))
```

##Calibrating Body Temperature Data
```{r}
setwd("/Users/robinbedard/Desktop/Thesis/csv files")
thermo_c <- read.csv("thermoc_calibration.csv")
thermo_coupl <- thermo_c %>%
  dplyr::select(Time, Value) %>% 
  mutate(Time = as.POSIXct(substr(Time, 1,5), format = "%H:%M"))
  
thermo_ref <- read.csv("thermalcouple_c_reference.csv") %>% 
  mutate(Time = as.POSIXct(Time, format = "%H:%M"))
  
thermo_c_final <- left_join(thermo_coupl, thermo_ref, by = "Time")
```

```{r}
#Calibrate Thermocouple Data
#First, calculate and save regression curves:
#calculate regression curves
regression_a <- lm(data = thermo_c_final,
                  Value ~ Temp)

# reate df to store calibration equations
TC_calibration <- data.frame(TC_A = (coef(regression_a))) %>%
  `rownames<-`(c("intercept", "slope"))

#Next, use calibration curves to correct the data we measured:
#this applies respective calibration equation
#to all cloacal thermocouple data points of that proper thermocouple
#2=slope & 1=intercept

all_snakes_final_3 <- all_snakes_final_2 %>%
  mutate(calibrated_cloacal_temp = Tb_at_CEWL*TC_calibration$TC_A[2] +
      TC_calibration$TC_A[1])
```

##Refactoring "Pregnant"
```{r}
# Get levels and add "Male"
levels <- levels(all_snakes_final_3$Pregnant)
levels[length(levels) + 1] <- "Male"

# refactor Preg to include "Male" as a factor level
# and replace NA with "None"
all_snakes_final_3$Pregnant <- factor(all_snakes_final_3$Pregnant, levels = c("Y", "N", "Male"))
all_snakes_final_3$Pregnant[is.na(all_snakes_final_3$Pregnant)] <- "Male"
```

##Correlation Plot
```{r}
corr_df <- all_snakes_final_3 %>%
  mutate(Indiv_ID = as.numeric(Indiv_ID)) %>%
  ungroup() %>%
  dplyr::select(Indiv_ID, Plasma_Osmol_Rep_mean, SVL_cm, Mass_g, calibrated_cloacal_temp, CEWL_g_m2h, msmt_temp_C, msmt_RH_percent, SMI)

chart.Correlation(corr_df, histogram=TRUE, pch=19)
```

##Initial Models

###CEWL

First, seeing which categorical variables are related to one another. 
```{r}
summary(lm(CEWL_g_m2h ~ CEWL_Blood_Collect_Date, data = all_snakes_final_3))
TukeyHSD(aov(CEWL_g_m2h ~ as.factor(CEWL_Blood_Collect_Date), all_snakes_final_3))
#collect date is not correlated with cewl
TukeyHSD(aov(CEWL_g_m2h ~ Rookery_Capture_ID, all_snakes_final_3))
#no rookeries are similar, don't have to include in model
summary(lm(CEWL_g_m2h ~ Date_of_Capture, data = all_snakes_final_3))
TukeyHSD(aov(CEWL_g_m2h ~ as.factor(Date_of_Capture), all_snakes_final_3))
#date of capture is correlated with cewl, will include in model
summary(lm(CEWL_g_m2h ~ Sex, data = all_snakes_final_3))
#no difference betweek sexes, wont include
summary(lm(CEWL_g_m2h ~ Pregnant, data = all_snakes_final_3))
TukeyHSD(aov(CEWL_g_m2h ~ Pregnant, all_snakes_final_3))
#no difference between pregnant and non pregnant snakes 
TukeyHSD(aov(CEWL_g_m2h ~ Life_Stage, all_snakes_final_3))
#no difference between life stages, wont include
TukeyHSD(aov(CEWL_g_m2h ~ Shed_Stage, all_snakes_final_3))
#no difference between shed stages
```


```{r}
CEWL_LMM_01 <- lm(data = all_snakes_final_3,
                  CEWL_g_m2h ~ 
                    msmt_temp_C)

CEWL_LMM_02 <- lm(data = all_snakes_final_3,
                          CEWL_g_m2h ~ 
                            msmt_temp_C + 
                           SVL_cm + 
                            SMI)

CEWL_LMM_03 <- lm(data = all_snakes_final_3,
                  CEWL_g_m2h/msmt_temp_C ~ 
                    SVL_cm + 
                    SMI)

CEWL_LMM_04 <- lm(data = all_snakes_final_3,
                  CEWL_g_m2h ~ Plasma_Osmol_Rep_mean)

CEWL_Tukey_Preg <- TukeyHSD(aov(Plasma_Osmol_Rep_mean ~ Pregnant, all_snakes_final_3))

CEWL_LM_05 <- lm(data = all_snakes_final_3,
                  CEWL_g_m2h ~ SMI)

summary(CEWL_LM_05)
summary(CEWL_LMM_04)
plot(CEWL_LMM_04)
summary(CEWL_LMM_03)
summary(CEWL_LMM_01)
summary(CEWL_LMM_02)
drop1(CEWL_LMM_01)
drop1(CEWL_LMM_02)
#vif(CEWL_LMM_01)
```

Saving the model tables as csv files separately 
```{r}
write.csv(broom::tidy(CEWL_LMM_01), "/Users/robinbedard/Desktop/Thesis/csv files/initial_measurements_model_1.csv")
write.csv(broom::tidy(CEWL_LMM_02), "/Users/robinbedard/Desktop/Thesis/csv files/initial_measurements_model_2.csv")
write.csv(broom::tidy(CEWL_LMM_04), "/Users/robinbedard/Desktop/Thesis/csv files/initial_measurements_cewl_osmol_regression.csv")
write.csv(broom::tidy(CEWL_Tukey_Preg), "/Users/robinbedard/Desktop/Thesis/csv files/Preg_Male_NonPreg_Pairwise.csv")
write.csv(broom::tidy(CEWL_LM_05), "/Users/robinbedard/Desktop/Thesis/csv files/SMI_CEWL_Regression.csv")
```

Saving the model tables and csv files together
```{r}
both_models <- data.frame(broom::tidy(CEWL_LMM_01)) %>%
rbind(data.frame(broom::tidy(CEWL_LMM_02))) %>%
  mutate(model = c(rep("CEWL; best mod", 2), rep("CEWL; 2nd best mod", 4)))

write.csv(both_models, "/Users/robinbedard/Desktop/Thesis/csv files/initial_measurements_both models.csv")
```

####Figures to support

CEWL and Osmolarity regression
```{r}
ggplot(data = all_snakes_final_3,
       aes(x = Plasma_Osmol_Rep_mean,
           y = CEWL_g_m2h)) +
  geom_point() +
  geom_smooth(method='lm') +
  labs(x = "Osmolarity (mmol/kg)",
       y = "CEWL (g/m^2h)", 
       title = "Regression of All Snakes' Initial Osmolarity vs. CEWL",
       subtitle = "p = 0.0469, t = 2.041, estimate = 0.1043, R^2 = 0.08144")
```

CEWL vs ambient temp
```{r}
ggplot(data = all_snakes_final_3,
       aes(x = msmt_temp_C,
           y = CEWL_g_m2h)) +
  geom_point() +
  geom_smooth(method='lm') +
  labs(x = "Ambient Temperature (C)",
       y = "CEWL (g/m^2h)", 
       title = "Ambient Temperature (C) vs. CEWL")
```

CEWL vs body condition
```{r}
ggplot(data = all_snakes_final_3,
       aes(x = SMI,
           y = CEWL_g_m2h)) +
  geom_point() +
  geom_smooth(method='lm') +
  labs(x = "SMI (Body Condition)",
       y = "CEWL (g/m^2h)")
```

CEWL vs SVL
```{r}
ggplot(data = all_snakes_final_3,
       aes(x = SVL_cm,
           y = CEWL_g_m2h)) +
  geom_point() +
  geom_smooth(method='lm') +
  labs(x = "SVL (mm)",
       y = "CEWL (g/m^2h)")
```

CEWL vs if preg or male
```{r}
ggplot(data = all_snakes_final_3,
       aes(x = Pregnant,
           y = CEWL_g_m2h,
           fill = Pregnant)) +
  geom_boxplot() +
  labs(x = "Pregnant (Y or N) or Male",
       y = "CEWL (g/m^2h)") +
  theme_classic() +
  stat_summary(fun = "mean") +
  theme(legend.position = "none")
```


###Osmolarity
First, seeing which categorical variables are related to one another.
```{r}
summary(lm(Plasma_Osmol_Rep_mean ~ CEWL_Blood_Collect_Date, data = all_snakes_final_3))
TukeyHSD(aov(Plasma_Osmol_Rep_mean ~ as.factor(CEWL_Blood_Collect_Date), all_snakes_final_3))
#collect date is not correlated with osmolarity
TukeyHSD(aov(Plasma_Osmol_Rep_mean ~ Rookery_Capture_ID, all_snakes_final_3))
#no rookeries are similar, don't have to include in model
summary(lm(Plasma_Osmol_Rep_mean ~ Date_of_Capture, data = all_snakes_final_3))
TukeyHSD(aov(Plasma_Osmol_Rep_mean ~ as.factor(Date_of_Capture), all_snakes_final_3))
#date of capture is not correlated with osmolarity
summary(lm(Plasma_Osmol_Rep_mean ~ Sex, data = all_snakes_final_3))
#no difference between sexes, wont include
summary(lm(Plasma_Osmol_Rep_mean ~ Pregnant, data = all_snakes_final_3))
TukeyHSD(aov(Plasma_Osmol_Rep_mean ~ Pregnant, all_snakes_final_3))
#no difference between pregnant and non pregnant snakes 
TukeyHSD(aov(Plasma_Osmol_Rep_mean ~ Life_Stage, all_snakes_final_3))
#no difference between life stages, wont include
TukeyHSD(aov(Plasma_Osmol_Rep_mean ~ Shed_Stage, all_snakes_final_3))
#no difference between shed stages
```

```{r}
ggplot(data = all_snakes_final_3,
       aes(y = Plasma_Osmol_Rep_mean)) +
  geom_boxplot()
```

```{r}
OSMOL_LM_01 <- lm(data = all_snakes_final_3,
                  Plasma_Osmol_Rep_mean ~ 
                    msmt_temp_C +
                    calibrated_cloacal_temp +
                    SMI)

drop1(OSMOL_LM_01)
#Ambient temp and smi can be taken out without difference in AIC
summary(OSMOL_LM_01)

OSMOL_LM_02 <- lm(data = all_snakes_final_3,
                  Plasma_Osmol_Rep_mean ~ 
                    calibrated_cloacal_temp)
summary(OSMOL_LM_02)
```

Saving the model tables 
```{r}
both_models_cewl <- data.frame(broom::tidy(OSMOL_LM_02)) %>%
  rbind(data.frame(broom::tidy(OSMOL_LM_01))) %>%
  mutate(model = c(rep("Osmolarity; best model", 4), rep("Osmolarity; 2nd best model", 2)))

write.csv(both_models_cewl, "/Users/robinbedard/Desktop/Thesis/csv files/initial_measurements_both models_osmoalrity.csv")
```

####Figures to support

Osmolarity vs ambient temp
```{r}
ggplot(data = all_snakes_final_3,
       aes(x = msmt_temp_C,
           y = Plasma_Osmol_Rep_mean)) +
  geom_point() +
  geom_smooth(method='lm') +
  labs(x = "Ambient Temperature (C)",
       y = "Osmolarity (mmol/kg)")
```

Osmolarity vs body temp
```{r}
ggplot(data = all_snakes_final_3,
       aes(x = calibrated_cloacal_temp,
           y = Plasma_Osmol_Rep_mean)) +
  geom_point() +
  geom_smooth(method='lm') +
  labs(x = "Body Temperature at Time of Measurement (C)",
       y = "Osmolarity (mmol/kg)")
```

Osmolarity vs body condition
```{r}
ggplot(data = all_snakes_final_3,
       aes(x = SMI,
           y = Plasma_Osmol_Rep_mean)) +
  geom_point() +
  geom_smooth(method='lm') +
  labs(x = "SMI (Body Condition)",
       y = "Osmolarity (mmol/kg)")
```
```{r}
all_lm <- lm(data = all_snakes_final_3, CEWL_g_m2h ~ Pregnant)
summary(all_lm)
anv <- aov(all_snakes_final_3$CEWL_g_m2h ~ all_snakes_final_3$Pregnant)
TukeyHSD(anv)

summary(all_snakes_final_3)
all_snakes_final_3 %>%
  ggplot(aes(x = Pregnant, y = CEWL_g_m2h)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean")
```

##Saving final data frame
```{r}
saveRDS(all_snakes_final_3, "/Users/robinbedard/Desktop/Thesis/RDS_Files/viridis_2022.RDS")
```

#2021 & 2022 Below Here
##Joining Data Sets
Joining the the data sets from CO 2021 and CO 2022

```{r}
viridis_2021_clean <- readRDS("viridis_2021_clean.RDS")
viridis_2022_clean <- readRDS("viridis_2022.RDS")

viridis_21_22 <- full_join(viridis_2021_clean, viridis_2022_clean)

```
Adding a new column for "Season"

```{r}
viridis_21_22_a <- viridis_21_22 %>%
  mutate(Season = "Summer")

viridis_21_22_a[1:87, 19] <- "Spring"

viridis_21_22_a[1:74, 3] <- "A"
viridis_21_22_a[75:87, 3] <- "J"
viridis_21_22_a[c(106,133), 3] <- "A"

viridis_21_22_a[c(1:26), 4] <- "Male"
viridis_21_22_a[30, 4] <- "Male"
viridis_21_22_a[c(42:44), 4] <- "Male"
viridis_21_22_a[c(69:75), 4] <- "Male"

levels(viridis_21_22_a$Pregnant) <- c(levels(viridis_21_22_a$Pregnant), "Juv F")
levels(viridis_21_22_a$Pregnant)  

viridis_21_22_a[76, 4] <- "Juv F"
viridis_21_22_a[c(77:80), 4] <- "Male"
viridis_21_22_a[81, 4] <- "Juv F"
viridis_21_22_a[c(82:83), 4] <- "Male"
viridis_21_22_a[c(84:87), 4] <- "Juv F"
```

Downloading the current dataset to compute equations for SMI
```{r}
saveRDS(viridis_21_22_a, "/Users/robinbedard/Desktop/Thesis/RDS_Files/viridis_2021_2022.RDS")
```

```{r}
Preg_F <- viridis_21_22_a %>%
  filter(Pregnant == "Y")

Preg_F_LM <- lm(data = Preg_F, Mass_g ~ SVL_cm * Season)
summary(Preg_F_LM)
```

```{r}
All_NonPreg <- viridis_21_22_a %>%
  filter(Pregnant != "Y")

All_NonPreg_LM <- lm(data = All_NonPreg, Mass_g ~ SVL_cm * Season)
summary(Preg_F_LM)
```

```{r}
All_NonPreg_LifeStage <- viridis_21_22_a %>%
  filter(Pregnant != "Y")

All_NonPreg_LifeStage_LM <- lm(data = All_NonPreg_LifeStage, Mass_g ~ SVL_cm * Life_Stage)
summary(All_NonPreg_LifeStage_LM)
unique(All_NonPreg_LifeStage$Life_Stage)
```

There was no difference in the relationship between mass and SVL so when making SMI equations, we grouped the years together

##Adding SMI to the Data Set 

```{r}
viridis_21_22_b <- viridis_21_22_a %>%
  # compute SMI
  mutate(SMI = case_when(Life_Stage == "J" ~ Mass_g * ((30.82857/SVL_cm) ^ 3.258838),
                         Pregnant != "Y" & Life_Stage == "A" ~ Mass_g * ((80.76104/SVL_cm) ^ 3.328707),
                         Pregnant == "Y" ~ Mass_g * ((80.02381/SVL_cm) ^ 2.74186)))
```

##Recoding Factored Variables
Recoding the pregnant variable so that all males and juveniles are NA. Keeping the old variable though. 

Renaming the old variable to "Preg_w_males_juvs"
```{r}
viridis_21_22_b <- rename(viridis_21_22_b, Preg_w_males_juvs = Pregnant)
```

Making a new column that includes reproductive state, sex, and life stage. 
```{r}
viridis_21_22_b <- viridis_21_22_b %>%
  mutate(Pregnant = ifelse(Preg_w_males_juvs == "Y", "Y",
                           ifelse(Preg_w_males_juvs == "N", "N", "NA")))

viridis_21_22_b <- viridis_21_22_b %>%
  mutate(Reproductive_LifeStage = ifelse(Pregnant == "Y", "Preg Adult F",
                                         ifelse(Pregnant == "N", "NonPreg Adult F",
                                                ifelse(Sex == "M" & Life_Stage == "A", "Adult M",
                                                       ifelse(Sex == "M" & Life_Stage == "J", "Juv M",
                                                              ifelse(Sex == "F" & Life_Stage == "J", "Juv F", NA))))))

levels(viridis_21_22_b$Pregnant)

viridis_21_22_b$Pregnant <- factor(viridis_21_22_b$Pregnant, levels = c("Y", "N", "NA"), labels = c("Y", "N", "NA"))

levels(viridis_21_22_b$Pregnant)

viridis_21_22_b$Season <- factor(viridis_21_22_b$Season, levels = c("Spring", "Summer"), labels = c("Spring", "Summer"))

levels(viridis_21_22_b$Season)

viridis_21_22_b$Life_Stage <- factor(viridis_21_22_b$Life_Stage, levels = c("A", "J"), labels = c("A", "J"))
levels(viridis_21_22_b$Life_Stage)
levels(viridis_21_22_b$Sex)

```


```{r}

```

##Plotting Raw Data CEWL

###CEWL vs. SVL
```{r}
ggplot(data = viridis_21_22_b, aes(x = SVL_cm, y = CEWL_g_m2h, colour = Season)) +
  geom_point() +
  theme_classic() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "SVL (cm)", y = "CEWL (g/m^2h)")

```

###CEWL vs. Body Condition
```{r}
ggplot(data = viridis_21_22_b, aes(x = SMI, y = CEWL_g_m2h, colour = Season)) +
  geom_point() +
  theme_classic() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Body Condition (SMI)", y = "CEWL (g/m^2h)")
```

###CEWL vs. Osmolarity
```{r}
ggplot(data = viridis_21_22_b, aes(x = Plasma_Osmol_Rep_mean, y = CEWL_g_m2h, colour = Season)) +
  geom_point() +
  theme_classic() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Plasma Osmolarity (mmol/kg)", y = "CEWL (g/m^2h)")
```

###CEWL vs. Season
```{r}
ggplot(data = viridis_21_22_b, aes(x = Season, y = CEWL_g_m2h, fill = Season)) +
  geom_boxplot() +
  theme_classic() +
  geom_point() +
  labs(x = "Season", y = "CEWL (g/m^2h)")
```
###CEWL vs. Sex
```{r}
ggplot(data = viridis_21_22_b, aes(x = Sex, y = CEWL_g_m2h, fill = Sex)) +
  geom_boxplot() +
  geom_point()
  theme_classic() +
  labs(x = "Sex", y = "CEWL (g/m^2h)")
```
###CEWL vs. Sex (Facet Wrap by if Pregnant)
```{r}
ggplot(data = viridis_21_22_b, aes(x = Sex, y = CEWL_g_m2h, fill = Sex)) +
  geom_boxplot() +
  theme_classic() +
  facet_wrap(~Pregnant + Season) +
  labs(x = "Sex", y = "CEWL (g/m^2h)")
```
###CEWL vs. Life Stage
```{r}
ggplot(data = viridis_21_22_b, aes(x = Life_Stage, y = CEWL_g_m2h, fill = Life_Stage)) +
  geom_boxplot() +
  theme_classic() +
  geom_point() +
  labs(x = "Life Stage", y = "CEWL (g/m^2h)")
```
###CEWL vs. Life Stage (Facet Wrap by Season)
```{r}
ggplot(data = viridis_21_22_b, aes(x = Life_Stage, y = CEWL_g_m2h, fill = Life_Stage)) +
  geom_boxplot() +
  geom_point() +
  theme_classic() +
  facet_wrap(~Season) +
  labs(x = "Life Stage", y = "CEWL (g/m^2h)")
```
###CEWL vs. Pregnant
```{r}
ggplot(data = viridis_21_22_b, aes(x = Pregnant, y = CEWL_g_m2h, fill = Pregnant)) +
  geom_boxplot() +
  geom_point() +
  theme_classic() +
  labs(x = "Life Stage", y = "CEWL (g/m^2h)")
```
###CEWL vs. Pregnant (Facet Wrap by Season)
```{r}
ggplot(data = viridis_21_22_b, aes(x = Pregnant, y = CEWL_g_m2h, fill = Pregnant)) +
  geom_boxplot() +
  geom_point() +
  theme_classic() +
  facet_wrap(~Season) +
  labs(x = "Life Stage", y = "CEWL (g/m^2h)")
```
###CEWL vs. Mass
```{r}
ggplot(data = viridis_21_22_b, aes(x = Mass_g, y = CEWL_g_m2h, colour = Season)) +
  geom_point() +
  theme_classic() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Mass (g)", y = "CEWL (g/m^2h)")
```
###CEWL vs. Body Temp
```{r}
ggplot(data = viridis_21_22_b, aes(x = calibrated_cloacal_temp, y = CEWL_g_m2h, colour = Season)) +
  geom_point() +
  theme_classic() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Body Temp (c)", y = "CEWL (g/m^2h)")
```
###CEWL vs. Ambient
```{r}
ggplot(data = viridis_21_22_b, aes(x = msmt_temp_C, y = CEWL_g_m2h, colour = Season)) +
  geom_point() +
  theme_classic() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Ambient Temp (c)", y = "CEWL (g/m^2h)")
```
###CEWL vs. Humidity
```{r}
ggplot(data = viridis_21_22_b, aes(x = msmt_RH_percent, y = CEWL_g_m2h, colour = Season)) +
  geom_point() +
  theme_classic() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Ambient Humidity", y = "CEWL (g/m^2h)")
```


##Initial Model CEWL

###Categorical Variable Test
First, seeing which categorical variables are significantly related to CEWL. 
```{r}

#Sample collection date 
TukeyHSD(aov(CEWL_g_m2h ~ as.factor(CEWL_Blood_Collect_Date), viridis_21_22_b))
#No difference between collection dates. Won't include in the model. 

#Season
summary(lm(CEWL_g_m2h ~ Season, data = viridis_21_22_b))
#Significant difference between seasons. Will include in the model. 

#Shed stage (only have data for the summer)
TukeyHSD(aov(CEWL_g_m2h ~ Shed_Stage, viridis_21_22_b))
#No differences between shed stages. Won't include in the model.

#Rookery capture ID
TukeyHSD(aov(CEWL_g_m2h ~ Rookery_Capture_ID, viridis_21_22_b))
#No differences between capture rookeries. Won't include in the model.

#Life stage, reproductive state, sex variable 
TukeyHSD(aov(CEWL_g_m2h ~ Reproductive_LifeStage, viridis_21_22_b))
#Significant difference between some groups. Will include in the model
```
Based on the above tests, the categorical variables that I will include are Reproductive_LifeStage and season. 

###Correlation Plot

Now, use correlation plot to determine which numeric variables should be used in the model. 
```{r}
corr_df2 <- viridis_21_22_b %>%
 # mutate(Indiv_ID = as.numeric(Indiv_ID)) %>%
 # ungroup() %>%
  dplyr::select(Plasma_Osmol_Rep_mean, SVL_cm, Mass_g, calibrated_cloacal_temp, CEWL_g_m2h, msmt_temp_C, msmt_RH_percent, SMI)

chart.Correlation(corr_df2, histogram=TRUE, pch=19)

cor(corr_df2, use = "complete.obs")

chisq.test(viridis_21_22_b$Sex, viridis_21_22_b$Pregnant)
chisq.test(viridis_21_22_b$Sex, viridis_21_22_b$Life_Stage)
chisq.test(viridis_21_22_b$Sex, viridis_21_22_b$Season)
```

Based on the correlation plot, I will include body temperature, mass, osmolarity, ambient temperature, humidity, and body condition in the model. 

Overall, all of the variables in the initial model should be Reproductive_LifeStage, season, body temperature, mass, osmolarity, ambient temperature, humidity, and body condition. 

###Initial Models

Initial, largest model with everything I think MAY need to be in the model. 
```{r}
CEWL_LM_1 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Reproductive_LifeStage +
                Season *  
                (Plasma_Osmol_Rep_mean + msmt_temp_C + calibrated_cloacal_temp + msmt_RH_percent) +
                SMI +
                Mass_g)

summary(CEWL_LM_1)
drop1(CEWL_LM_1)
vif(CEWL_LM_1)
```

Lower AIC is better. So the row "AIC" shows what the AIC would be if that variable was dropped from the model. So, if a variable is outside of the +/- 2 range and the value would be lower if dropped, then it should be taken out of the model. When looking at the AIC, you want to drop the lowest AIC's that are outside of the +/- 2 range from the "none" dropped AIC. Then, rerun the model and do it again to see if any others should be dropped after dropping that one. Continue process until no more can be dropped or until no more are outside of the +/- 2 range. Once none are outside of that range, you create two models that are equivalent in their predictive power. One is just simpler than the other one. 

Based on model 1, there are no variables that AIC suggest to drop, but I am going to keep reducing until I get to the null model. AIC without dropping any is 287.77. Since dropping mass would result in the lowest AIC, I am going to start with dropping mass and do the same thing. Dropping mass results in an AIC of 286.47 
```{r}
CEWL_LM_2 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Reproductive_LifeStage +
                Season *  
                (Plasma_Osmol_Rep_mean + msmt_temp_C + calibrated_cloacal_temp + msmt_RH_percent) +
                SMI)

summary(CEWL_LM_2)
drop1(CEWL_LM_2)
vif(CEWL_LM_2)
```
Based on model 2, there are still no variables that should be dropped based on AIC, but I am going to keep reducing until I get to the null model. AIC without dropping any is 286.47. Since dropping the interaction between season and humidity would result in the lowest AIC, I am going to drop that. Dropping this interaction would result in an AIC of 285.41. I am still going to keep the individual effect of humidity in. 

```{r}
CEWL_LM_3 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Reproductive_LifeStage +
                Season *  
                (Plasma_Osmol_Rep_mean + msmt_temp_C + calibrated_cloacal_temp) +
                SMI +
                msmt_RH_percent)

summary(CEWL_LM_3)
drop1(CEWL_LM_3)
vif(CEWL_LM_3)
```

Based on model 3, there are still no variables that should be dropped based on AIC, but I am going to keep reducing until I get to the null model. AIC without dropping any is 285.41. Since dropping the interaction between season and calibrated cloacal temp would result in the lowest AIC, I am going to drop that. Dropping this interaction would result in an AIC of 285.41 I am still going to keep the individual effect of cloacal temp in. 
```{r}
CEWL_LM_4 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Reproductive_LifeStage +
                Season *  
                (Plasma_Osmol_Rep_mean + msmt_temp_C) +
                SMI +
                msmt_RH_percent +
                calibrated_cloacal_temp)

summary(CEWL_LM_4)
drop1(CEWL_LM_4)
vif(CEWL_LM_4, type = "high-order")
```
Based on model 4, there are still no variables that should be dropped based on AIC, but I am going to keep reducing until I get to the null model. AIC without dropping any is 285.81. Since dropping body temp would result in the lowest AIC, I am going to drop that. Dropping this would result in an AIC of 285.29.

```{r}
CEWL_LM_5 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Reproductive_LifeStage +
                Season *  
                (Plasma_Osmol_Rep_mean + msmt_temp_C) +
                SMI +
                msmt_RH_percent)

summary(CEWL_LM_5)
drop1(CEWL_LM_5)
vif(CEWL_LM_5)
```
Based on model 5, there are still no variables that should be dropped based on AIC, but I am going to keep reducing until I get to the null model. AIC without dropping any is 285.29. Since dropping humidity would result in the lowest AIC, I am going to drop that. Dropping this would result in an AIC of 287.88.

```{r}
CEWL_LM_6 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Reproductive_LifeStage +
                Season *  
                (Plasma_Osmol_Rep_mean + msmt_temp_C) +
                SMI)

summary(CEWL_LM_6)
drop1(CEWL_LM_6)
vif(CEWL_LM_6)
```

Based on model 6, there are still no variables that should be dropped based on AIC, but I am going to keep reducing until I get to the null model. AIC without dropping any is 287.88. Since dropping the interaction between season and osmolarity would result in the lowest AIC, I am going to drop that. Dropping this would result in an AIC of 291.55. I am still going to keep the individual effect of osmolarity. 

```{r}
CEWL_LM_7 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Reproductive_LifeStage +
                Season * 
                msmt_temp_C +
                Plasma_Osmol_Rep_mean)
              

summary(CEWL_LM_7)
drop1(CEWL_LM_7)
vif(CEWL_LM_7)
```
Based on model 7, there are still no variables that should be dropped based on AIC, but I am going to keep reducing until I get to the null model. AIC without dropping any is 307.94. Since dropping osmolarity would result in the lowest AIC, I am going to drop that. Dropping this would result in an AIC of 306.66.

```{r}
CEWL_LM_8 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Reproductive_LifeStage +
                Season * 
                msmt_temp_C)
              

summary(CEWL_LM_8)
drop1(CEWL_LM_8)
vif(CEWL_LM_8)
```
Based on model 7, the variable of reproductive state, life stage, and sex, should be dropped and would result in a significiantly lower AIC. The AIC without dropping any variables would be 361.96. If the variable of reproductive state, life stage, and sex is dropped the AIC is 356.54. 

```{r}
CEWL_LM_9 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Season * 
                msmt_temp_C)
              

summary(CEWL_LM_9) 
drop1(CEWL_LM_9)
vif(CEWL_LM_9)
```
Now going to only look at the interaction, not the individual effect. 
```{r}
CEWL_LM_10 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Season : 
                msmt_temp_C)
              

summary(CEWL_LM_10) 
drop1(CEWL_LM_10)
vif(CEWL_LM_10)
```
Now looking at only the individual effects, without the interaction. 
```{r}
CEWL_LM_11 <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                Season + 
                msmt_temp_C)
              

summary(CEWL_LM_11) 
drop1(CEWL_LM_11)
vif(CEWL_LM_11)
```
Based on model 11, dropping the season variable would result in the lowest AIC. 

```{r}
CEWL_LM_null <- lm(data = viridis_21_22_b,
              CEWL_g_m2h ~
                msmt_temp_C)
              

summary(CEWL_LM_null) 
drop1(CEWL_LM_null)
vif(CEWL_LM_null)
```

###Model Selection


```{r CEWL mod compare}
CEWL_models <- list(CEWL_LM_1, CEWL_LM_2, CEWL_LM_3, CEWL_LM_4, CEWL_LM_5, CEWL_LM_6, CEWL_LM_7, CEWL_LM_8, CEWL_LM_9, CEWL_LM_10, CEWL_LM_11, CEWL_LM_null)

#specify model names
CEWL_mod_names <- c('model1', 
                    'model2', 
                    'model3',
                    'model4',
                    'model5',
                    'model6',
                    'model7',
                    'model8',
                    'model9',
                    'model10',
                    'model11',
                    'modelnull')

#calculate AIC of each model
CEWL_AICc <- data.frame(aictab(cand.set = CEWL_models, 
                                 modnames = CEWL_mod_names))
CEWL_AICc
```
The best models are 5 and 4. 
Check that the best model meets the criteria for linear regression and has no collinearity.

```{r CEWL model assumptions}
vif(CEWL_LM_4)
vif(CEWL_LM_4, type = "marginal")
vif(CEWL_LM_4, type = "high-order")
plot(CEWL_LM_4)


simple.eda(residuals(CEWL_LM_4))
shapiro.test(residuals(CEWL_LM_4))


vif(CEWL_LM_5)
vif(CEWL_LM_5, type = "marginal")
vif(CEWL_LM_5, type = "high-order")
plot(CEWL_LM_5)
simple.eda(residuals(CEWL_LM_5))
shapiro.test(residuals(CEWL_LM_5))
```














