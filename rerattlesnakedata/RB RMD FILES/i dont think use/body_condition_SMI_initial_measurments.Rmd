---
title: "Body Condition Wrangling - all snake initial measurements"
author: "Robin Bedard"
date: "2022"
output: pdf_document
toc: TRUE
---


# Compute Scaled Mass Index

This is also known as the body condition index, or log-log residuals.

I calculate as described by: Peig, J., & Green, A. J. (2009). New perspectives for estimating body condition from mass/length data: The scaled mass index as an alternative method. Oikos, 118(12), 1883â€“1891. https://doi.org/10.1111/j.1600-0706.2009.17643.x

### Step 1: Simple Linear Regression

I only use capture mass measurements for these calculations because that's what's representative of body condition naturally.

```{r SMI SLR}
#load in data
library(tidyverse)

SLR_dat <- readRDS("all_snakes_final.RDS")

#dataframe with only females
SLR_dat_female_only <- SLR_dat %>%
  dplyr::filter(Sex == "F") 

#dataframe with all individuals that are not pregnant females 
SLR_dat_allnonpreg <- SLR_dat %>% 
  filter((Pregnant != "Y") %>% 
           replace_na(TRUE))

#running initial lm on all female snakes to see if there if an effect of any variables on mass. Since whether or not a snake is pregnant significantly impacts their mass, we have to create separate calculations for the two groups (preg females, non preg)
mass_SVL_SLR_females <- lm(data = SLR_dat_female_only, Mass_g ~ SVL_cm * Pregnant * Life_Stage)
summary(mass_SVL_SLR_females)

#Can we include the non preg females with the males? Yes, because only SVL influenced mass.
mass_SVL_SLR_allnonpreg <- lm(data = SLR_dat_allnonpreg, Mass_g ~ SVL_cm * Sex * Life_Stage)
summary(mass_SVL_SLR_allnonpreg)
```


### Step 2: Identify Outliers



```{r SMI equation outliers 1}
plot(mass_SVL_SLR_females)
plot(mass_SVL_SLR_allnonpreg)

#both look good enough
```

The conditions of linearity, equal error variance, and normality are all satisfied.

```{r SMI equation outliers 2}
boxplot(residuals(mass_SVL_SLR_females))
hist(residuals(mass_SVL_SLR_females)) 

boxplot(residuals(mass_SVL_SLR_allnonpreg))
hist(residuals(mass_SVL_SLR_allnonpreg)) 
```

Check average residual value:

```{r SMI equation outliers 3}
mean(residuals(mass_SVL_SLR_females))
median(residuals(mass_SVL_SLR_females))

mean(residuals(mass_SVL_SLR_allnonpreg))
median(residuals(mass_SVL_SLR_allnonpreg))
```

Looks like I will have to remove some points because the median is too far from 0.

Check for high leverage points:

```{r SMI equation outliers 4}
# compute values for observations 
high_leverage_females <- data.frame(H = hatvalues(mass_SVL_SLR_females)) %>% 
  mutate(row = row_number())

# compute cutoff value 
h_bar <- (3*sum(high_leverage_females$H))/nrow(high_leverage_females)

# add to original dataframe 
# see which observations have extremely high leverage (if any)
high_leverage_dat_females <- SLR_dat_female_only %>%
  mutate(row = row_number()) %>%
  left_join(., high_leverage_females, by = "row") %>%
  dplyr::filter(H > h_bar) 
high_leverage_dat_females





# compute values for observations 
high_leverage_nonpreg <- data.frame(H = hatvalues(mass_SVL_SLR_allnonpreg)) %>% 
  mutate(row = row_number())

# compute cutoff value 
h_bar <- (3*sum(high_leverage_nonpreg$H))/nrow(high_leverage_nonpreg)

# add to original dataframe 
# see which observations have extremely high leverage (if any)
high_leverage_dat_nonpreg <- SLR_dat_allnonpreg %>%
  mutate(row = row_number()) %>%
  left_join(., high_leverage_nonpreg, by = "row") %>%
  dplyr::filter(H > h_bar) 
high_leverage_nonpreg

#Don't have enough points to determine if there can be points to remove 

```

No points are considered high leverage for female only, which is fantastic. Not enough individuals in the other to determine if some can be removed.

Check for influential points based on Cook's distance: only doing for the all females because this is the only it applys to. 

```{r SMI equation outliers 5}
# get Cook's distance 
cooks <- data.frame(c = cooks.distance(mass_SVL_SLR_females)) %>% 
  mutate(row = row_number())

# add to original dataframe 
influential <- SLR_dat_female_only %>%
  mutate(row = row_number()) %>% 
  left_join(., cooks, by = "row")

# see moderately influential points 
cook_mod_inf <- influential %>% 
  dplyr::filter(c>0.5) 
cook_mod_inf
```

There are no infuential points based on Cook's distance, so there's nothing to potentially remove.

No points were indicated to be outliers based on residuals or a histogram, and there were no high leverage or influential points. Thus I can create a log-log model using the data as-is. Observation omissions are unlikely to increase generalizability.


 
### Step 3: log-log Regression

```{r SMI log log regression}
log_mass_SVL_SLR_females <- lm(data = SLR_dat_female_only, log(Mass_g) ~ log(SVL_cm))
summary(log_mass_SVL_SLR_females)

log_mass_SVL_SLR_allnonpreg <- lm(data = SLR_dat_allnonpreg, log(Mass_g) ~ log(SVL_cm))
summary(log_mass_SVL_SLR_allnonpreg)
```


### Step 4: Extract Values

compute standardized major axis using the log-log regression equation:

```{r SMI equation}
r <- sqrt(0.8727) # Pearson's correlection coefficient (sqrt of R-squared)
b_OLS <- 2.8945 # regression slope
b_SMA <- b_OLS/r

r_2 <- sqrt(0.9729) # Pearson's correlection coefficient (sqrt of R-squared)
b_OLS_2 <- 2.9893  # regression slope
b_SMA_2 <- b_OLS_2/r_2

```

mean length in capture data:

```{r mean SVL}
L0_females <- mean(SLR_dat_female_only$SVL_cm)

L0_allnonpreg <- mean(SLR_dat_allnonpreg$SVL_cm)
```


### Step 5: Calculate Scaled Mass Index

Add SMI to an updated full_dat df - full_dat2

```{r join all data}
SMI_values <- SLR_dat %>%
  # compute SMI
  mutate(SMI = case_when(Pregnant == "Y" ~ Mass_g * ((77.55152/SVL_cm) ^ 3.098426), 
                         Pregnant != "Y" ~ Mass_g * ((78.34545/SVL_cm) ^ 3.030647),
                         is.na(Pregnant) == TRUE ~ Mass_g * ((78.34545/SVL_cm) ^ 3.030647)))

ggplot(SMI_values) + 
  geom_point(aes(x = Mass_g,
                 y = SMI,
                 color = Pregnant))
```













