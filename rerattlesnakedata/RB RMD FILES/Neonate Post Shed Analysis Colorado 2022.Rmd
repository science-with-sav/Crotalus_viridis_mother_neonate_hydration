---
title: "Neonate Postshed Analysis"
author: "Robin Bedard"
date: '2022-11-17'
output: pdf_document
---
```{r setup, include = TRUE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
```
#Uploading Data
```{r}
neonate_postshed_clean <- readRDS("neonate_postshed_clean.RDS")
```

#Osmolarity Wrangling

I need to create a df with only the relevant osmolarity data information and a df with all other columns, save them both as RDS, then do the osmolarity wrangling. 

```{r}
neonate_postshed_final <- neonate_postshed_clean %>%
  dplyr::select(Indiv_ID, Date_Born, Tail_Length_cm, SVL_cm, Tail_SVL_Ratio, Mass_g, Sex, Mother_ID, Treatment, Tb_CEWL_c, Pee, CEWL_Blood_Collect_Date)

neonate_postshed_temp <- neonate_postshed_clean %>%
  dplyr::select(-c(Date_Born, Tail_Length_cm, SVL_cm, Tail_SVL_Ratio, Mass_g, Sex, Mother_ID, Treatment, Tb_CEWL_c, Pee))
```

```{r load data}
#Create a data frame called osml_reps_o.
osml_reps_0 <- neonate_postshed_temp 

#Creating a new df by selecting out all of the rep 1 values.
osml_reps_1 <- osml_reps_0 %>%
  dplyr::select(Indiv_ID, CEWL_Blood_Collect_Date, Date_Blood_Analyzed, Plasma_Osmol_Rep = Plasma_Osmol_Rep1) %>%
  mutate(Rep = "1") 

#Creating a new df by selecting out all of the rep 2 values. 
osml_reps_2 <- osml_reps_0 %>%
  dplyr::select(Indiv_ID, CEWL_Blood_Collect_Date, Date_Blood_Analyzed, Plasma_Osmol_Rep = Plasma_Osmol_Rep2) %>%
  mutate(Rep = "2") 

#Creating a new df by selecting out all of the rep 3 values.
osml_reps_3 <- osml_reps_0 %>%
  dplyr::select(Indiv_ID, CEWL_Blood_Collect_Date, Date_Blood_Analyzed, Plasma_Osmol_Rep = Plasma_Osmol_Rep3) %>%
  mutate(Rep = "3") 

#Creating a new df by selecting out all of the rep 4 values
osml_reps_4 <- osml_reps_0 %>%
  dplyr::select(Indiv_ID, CEWL_Blood_Collect_Date, Date_Blood_Analyzed, Plasma_Osmol_Rep = Plasma_Osmol_Rep4) %>%
  mutate(Rep = "4") 

#Rbinding all of the previously made df together so that all of the technical osmolarity replicates are in once column. They have to be like this for the analysis. Then, filter out all of the replicates so the data frame only consists of the complete cases. The incomplete cases are from the blood samples that didn't have enough plasma to run multiple replicates. 
osml_reps <- osml_reps_1 %>%
  rbind(osml_reps_2) %>%
  rbind(osml_reps_3) %>%
  rbind(osml_reps_4) %>%
dplyr::filter(complete.cases(Plasma_Osmol_Rep))

#View a summary of the osml_reps to see that all of the reps are in the same column
summary(osml_reps)
```

##Replicates

Now, I will try to identify outliers within the replicates for a given individual on a given date. There must be at least 3 replicates to do this, so the first thing I need to do is figure out which individuals/dates have enough replicates, then subset my data to be only those individuals.

## Individuals with 3+ Replicates

```{r separate data w enough reps to assess}

# identify the individuals with at least 3-4 osmolarity reps
enuf_reps <- osml_reps %>%
  group_by(Indiv_ID, CEWL_Blood_Collect_Date) %>%
  mutate(count = n()) %>%
  dplyr::filter(count > 2) %>%
  arrange(count)
enuf_reps

# identify individuals with 1-2 reps
not_reps <- osml_reps %>%
  group_by(Indiv_ID, CEWL_Blood_Collect_Date) %>%
  mutate(count = n()) %>%
  dplyr::filter(count < 3) %>%
  arrange(count)
not_reps

# check that the total number of observations still add to original 340
nrow(enuf_reps) + nrow(not_reps)
nrow(enuf_reps) + nrow(not_reps) == nrow(osml_reps)
```

## Assess Variation

We want the Coefficient of Variation (CV) among our technical replicates to be small. We need to calculate it to identify whether there may be outliers.

```{r calculate CVs}

#creating a variable cv to determine if there may be outliers. 
CVs <- enuf_reps %>%
  group_by(Indiv_ID, CEWL_Blood_Collect_Date) %>%
  summarise(mean = mean(Plasma_Osmol_Rep),
            SD = sd(Plasma_Osmol_Rep),
            CV = (SD/mean) *100,
            min = min(Plasma_Osmol_Rep),
            max = max(Plasma_Osmol_Rep),
            range = max - min
            )
summary(CVs)
hist(CVs$CV)
hist(CVs$range) 

#Not really any replicates here so cant really do this. 
```

Ideally, CV would be 10-15%. If it's larger, and one of the replicates is very different than the others, we can assume that the replicates that are closer together are more reliable. 

## Find Outliers

```{r create find outlier function}
# write function to find outliers for each individual on each date
find_outliers <- function(df) {
  
  # initiate dataframe to compile info and list to compile plots
  outliers <- data.frame()
  #boxplots <- list()

  # initiate a for loop to go through every who in df
  for(indiv_ch in unique(df$Indiv_ID)) {
    
    # select data for only the individual of interest
    df_sub <- df %>%
      dplyr::filter(Indiv_ID == as.numeric(indiv_ch))
    
    # make a boxplot
    df_sub %>%
      ggplot(.) +
      geom_boxplot(aes(x = as.factor(CEWL_Blood_Collect_Date),
                       y = Plasma_Osmol_Rep,
                       fill = as.factor(CEWL_Blood_Collect_Date))) +
      ggtitle(paste("Individual", indiv_ch)) +
      theme_classic() -> plot
    
    stats <- ggplot_build(plot)$data[[1]] %>%
  mutate(x = as.numeric(x))
    
    # print/save
    print(plot)
    #boxplots[[indiv_ch]] <- plot
    
    # extract outliers
    outs <- df_sub %>%
      group_by(Indiv_ID, CEWL_Blood_Collect_Date) %>%
      summarise(n=n()) %>%
      arrange(CEWL_Blood_Collect_Date) %>%
      mutate(x = seq(1, nrow(.))) %>%
      left_join(stats) %>%
      select(Indiv_ID, CEWL_Blood_Collect_Date, outliers)
    
    # add to running dataframe of outliers
    outliers <- outliers %>%
      rbind(outs)
  }
  #return(boxplots)
  return(outliers)
}

```




Now apply the function to the data:

```{r find outlier using boxplots, fig.show="hold", out.width="50%"}

#Running this will give boxplots for each individual with each date that blood samples were run. It will visually show if there are any outliers. 
par(mfrow = c(71, 2))
outliers_found <- find_outliers(enuf_reps)
outliers_found
par(mfrow = c(1, 1))



outliers_found %>%
  filter(outliers != "numeric(0)")
  
unique(outliers_found$outliers)
```

## Remove Outliers

```{r remove outlier}
#library(tidyverse)

#enuf_reps_trimmed$outliers[[1]]

# filter out the one NA
enuf_reps_trimmed <- enuf_reps %>%
  left_join(outliers_found, by = c("Indiv_ID", "CEWL_Blood_Collect_Date")) %>%
  dplyr::filter(outliers %nin% c("NULL")) %>% 
  dplyr::filter((Plasma_Osmol_Rep != outliers | outliers == "numeric(0)"))
```

## Average Remaining Replicates

Now that the outliers are removed from the technical replicates when there were enough replicates to identify them, I will average the remaining replicates of the rejoined data for lizards with 1-2 and 3-4 replicates.

```{r calculate means}
osml_means <- not_reps %>%
  rbind(enuf_reps_trimmed) %>%
  group_by(CEWL_Blood_Collect_Date, Indiv_ID) %>%
  summarise(Plasma_Osmol_Rep_mean = mean(Plasma_Osmol_Rep))
```

##Merging Dataframes
```{r}
neonate_postshed_all_final <- left_join(neonate_postshed_final, osml_means, by = c("CEWL_Blood_Collect_Date", "Indiv_ID"))
#reading in CEWL data
all_data_CEWL <- readRDS("CEWL_data_all_clean.RDS")
#merging all together
neonate_postshed_all_final <- left_join(neonate_postshed_all_final, all_data_CEWL, by = c("Indiv_ID" = "individual_ID", "CEWL_Blood_Collect_Date" = "date"))
```
 
Now the final dataframe has all of the neonate post shed measurements together. Now I will calibrate body temperature data. 

#Body Temperature Calibration

```{r}
setwd("/Users/robinbedard/Desktop/Thesis/csv files")
thermo_c <- read.csv("thermoc_calibration.csv")
thermo_coupl <- thermo_c %>%
  dplyr::select(Time, Value) %>% 
  mutate(Time = as.POSIXct(substr(Time, 1,5), format = "%H:%M"))

thermo_ref <- read.csv("thermalcouple_c_reference.csv") %>% 
  mutate(Time = as.POSIXct(Time, format = "%H:%M"))

thermo_c_final <- left_join(thermo_coupl, thermo_ref, by = "Time")
```

Calibrate Thermocouple Data
First, calculate and save regression curves: calculate regression curves
```{r}
regression_a <- lm(data = thermo_c_final,
                   Value ~ Temp)
```

Create df to store calibration equations
```{r}
TC_calibration <- data.frame(TC_A = (coef(regression_a))) %>%
  `rownames<-`(c("intercept", "slope"))
```

Next, use calibration curves to correct the data we measured:
this applies respective calibration equation to all cloacal thermocouple data points of that proper thermocouple. 2=slope & 1=intercept
```{r}
neonate_postshed_all_final_2 <- neonate_postshed_all_final %>%
  mutate(calibrated_cloacal_temp = Tb_CEWL_c*TC_calibration$TC_A[2] +
           TC_calibration$TC_A[1])
summary(neonate_postshed_all_final_2)
```

Body temperature data is complete.










