---
title: "Body Condition Wrangling - all snake initial measurements"
author: "Robin Bedard"
date: "2022"
output: pdf_document
toc: TRUE
---


# Compute Scaled Mass Index

This is also known as the body condition index, or log-log residuals.

I calculate as described by: Peig, J., & Green, A. J. (2009). New perspectives for estimating body condition from mass/length data: The scaled mass index as an alternative method. Oikos, 118(12), 1883â€“1891. https://doi.org/10.1111/j.1600-0706.2009.17643.x

### Step 1: Simple Linear Regression

I only use capture mass measurements for these calculations because that's what's representative of body condition naturally.

```{r SMI SLR}
#load in data
library(tidyverse)

SLR_dat <- readRDS("viridis_2021_2022.RDS")

#In the Viridis 2021 2022 analysis RMD, I found that there was no difference in the relationship between mass and SVL across seasons so when making SMI equations, we are grouping the years together. However, there is a difference between pregnant females, all non pregnant adults (males and females) and juveniles. So, I have to make 3 separate equations. The linear models showing this are on the analysis RMD.

#dataframe with only pregnant females
SLR_dat_Preg_female_only <- SLR_dat %>%
  dplyr::filter(Pregnant == "Y") 

#dataframe with all male and female not pregnant adults
SLR_dat_allnonpreg_adults <- SLR_dat %>% 
  filter((Pregnant != "Y" & Life_Stage == "A")) 

#dataframe with all juveniles
SLR_dat_juvenile_only <- SLR_dat %>%
  dplyr::filter(Life_Stage == "J")

#Making linear models for the three groups to use in the creation of the SMI equations. 
Preg_LM <- lm(data = SLR_dat_Preg_female_only, Mass_g ~ SVL_cm)
summary(Preg_LM)

Adult_NonPreg_LM <- lm(data = SLR_dat_allnonpreg_adults, Mass_g ~ SVL_cm)

Juvenile_LM <- lm(data = SLR_dat_juvenile_only, Mass_g ~ SVL_cm)

ggplot(data = SLR_dat_juvenile_only,
       aes(x = SVL_cm, y = Mass_g)) +
geom_point()

ggplot(data = Adult_NonPreg_LM,
       aes(x = SVL_cm, y = Mass_g)) +
geom_point()
```


### Step 2: Identify Outliers
```{r SMI equation outliers 1}
plot(Preg_LM)
plot(Adult_NonPreg_LM)
plot(Juvenile_LM)

#both look good enough
```

The conditions of linearity, equal error variance, and normality are all satisfied.
```{r SMI equation outliers 2}
boxplot(residuals(Preg_LM))
hist(residuals(Preg_LM)) 

boxplot(residuals(Adult_NonPreg_LM))
hist(residuals(Adult_NonPreg_LM)) 

boxplot(SLR_dat_allnonpreg_adults$Mass_g)
hist(SLR_dat_allnonpreg_adults$Mass_g)

boxplot(SLR_dat_allnonpreg_adults$SVL_cm)
hist(SLR_dat_allnonpreg_adults$SVL_cm)

boxplot(residuals(Juvenile_LM))
hist(residuals(Juvenile_LM)) 
```

Check average residual value:
```{r SMI equation outliers 3}
mean(residuals(Preg_LM))
median(residuals(Preg_LM))

mean(residuals(Adult_NonPreg_LM))
median(residuals(Adult_NonPreg_LM))

mean(residuals(Juvenile_LM))
median(residuals(Juvenile_LM))
```

Looks like I will have to remove some points because the median is too far from 0.

Check for high leverage points:
```{r SMI equation outliers 4}

#PREGNANT FEMALES
# compute values for observations 
high_leverage_females <- data.frame(H = hatvalues(Preg_LM)) %>% 
  mutate(row = row_number())

# compute cutoff value 
h_bar <- (3*sum(high_leverage_females$H))/nrow(high_leverage_females)

# add to original dataframe 
# see which observations have extremely high leverage (if any)
high_leverage_dat_females <- SLR_dat_Preg_female_only %>%
  mutate(row = row_number()) %>%
  left_join(., high_leverage_females, by = "row") %>%
  dplyr::filter(H > h_bar) 

high_leverage_dat_females


#NONPREGNANT ADULT MALES AND FEMALES 
# compute values for observations 
high_leverage_nonpreg <- data.frame(H = hatvalues(Adult_NonPreg_LM)) %>% 
  mutate(row = row_number())

# compute cutoff value 
h_bar <- (3*sum(high_leverage_nonpreg$H))/nrow(high_leverage_nonpreg)

# add to original dataframe 
# see which observations have extremely high leverage (if any)
high_leverage_dat_nonpreg <- SLR_dat_allnonpreg_adults %>%
  mutate(row = row_number()) %>%
  left_join(., high_leverage_nonpreg, by = "row") %>%
  dplyr::filter(H > h_bar) 
high_leverage_nonpreg

#This says to delete pretty much half of the data set which we can't obvioisly do... There aren't any outliers when looking at basic boxplots and histograms so I am going to leave them all in. 


#JUVENILES
# compute values for observations 
high_leverage_juveniles <- data.frame(H = hatvalues(Juvenile_LM)) %>% 
  mutate(row = row_number())

# compute cutoff value 
h_bar <- (3*sum(high_leverage_juveniles$H))/nrow(high_leverage_juveniles)

# add to original dataframe 
# see which observations have extremely high leverage (if any)
high_leverage_dat_juveniles <- SLR_dat_juvenile_only %>%
  mutate(row = row_number()) %>%
  left_join(., high_leverage_juveniles, by = "row") %>%
  dplyr::filter(H > h_bar) 
high_leverage_juveniles

#Too few to detect anything so just keep them all in 
```

Check for influential points based on Cook's distance: only doing for the all females because this is the only it applys to. 

#```{r SMI equation outliers 5}
# get Cook's distance 
cooks <- data.frame(c = cooks.distance(mass_SVL_SLR_females)) %>% 
  mutate(row = row_number())

# add to original dataframe 
influential <- SLR_dat_female_only %>%
  mutate(row = row_number()) %>% 
  left_join(., cooks, by = "row")

# see moderately influential points 
cook_mod_inf <- influential %>% 
  dplyr::filter(c>0.5) 
cook_mod_inf


There are no infuential points based on Cook's distance, so there's nothing to potentially remove.

No points were indicated to be outliers based on residuals or a histogram, and there were no high leverage or influential points. Thus I can create a log-log model using the data as-is. Observation omissions are unlikely to increase generalizability.


 
### Step 3: log-log Regression

```{r SMI log log regression}
#Pregnant femlaes
log_Preg_LM <- lm(data = SLR_dat_Preg_female_only, log(Mass_g) ~ log(SVL_cm))
summary(log_Preg_LM)

#Nonpregnant adults male and female 
log_Adult_NonPreg_LM <- lm(data = SLR_dat_allnonpreg_adults, log(Mass_g) ~ log(SVL_cm))
summary(log_Adult_NonPreg_LM)

#Juveniles
log_Juvenile_LM <- lm(data = SLR_dat_juvenile_only, log(Mass_g) ~ log(SVL_cm)) 
summary(log_Juvenile_LM)
```


### Step 4: Extract Values

compute standardized major axis using the log-log regression equation:

```{r SMI equation}
#Pregnant Females
r <- sqrt(0.6281) # Pearson's correlection coefficient (sqrt of R-squared)
b_OLS <- 2.1730 # regression slope
b_SMA <- b_OLS/r

#Nonpregnant adults male and female 
r_2 <- sqrt(0.8719) # Pearson's correlection coefficient (sqrt of R-squared)
b_OLS_2 <- 3.1082  # regression slope
b_SMA_2 <- b_OLS_2/r_2

#Juveniles 
r_3 <- sqrt(0.8903) # Pearson's correlection coefficient (sqrt of R-squared)
b_OLS_3 <- 3.0749  # regression slope
b_SMA_3 <- b_OLS_3/r_3

```

mean length in capture data:

```{r mean SVL}
L0_preg_females <- mean(SLR_dat_Preg_female_only$SVL_cm, na.rm = TRUE)

L0_allnonpreg_adults <- mean(SLR_dat_allnonpreg_adults$SVL_cm, na.rm = TRUE)

L0_juveniles <- mean(SLR_dat_juvenile_only$SVL_cm, na.rm = TRUE)
```


### Step 5: Calculate Scaled Mass Index

Add SMI to an updated full_dat df - full_dat2

```{r join all data}
SMI_values <- SLR_dat %>%
  # compute SMI
  mutate(SMI = case_when(Life_Stage == "J" ~ Mass_g * ((30.82857/SVL_cm) ^ 3.258838),
                         Pregnant != "Y" & Life_Stage == "A" ~ Mass_g * ((80.76104/SVL_cm) ^ 3.328707),
                         Pregnant == "Y" ~ Mass_g * ((80.02381/SVL_cm) ^ 2.74186)))
                        


                 
                         

ggplot(SMI_values) + 
  geom_point(aes(x = Mass_g,
                 y = SMI,
                 color = Pregnant))
```













