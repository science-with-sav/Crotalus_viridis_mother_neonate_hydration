---
title: "Colorado viridis - Mother Plasma Osmolality Data Wrangling"
author: "Robin Bedard"
date: "2022"
output: pdf_document
toc: TRUE
---


# Packages

```{r setup, include = TRUE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
```

# Load Data

```{r load data}
#reading in the RDS file from the CO_2022_Initial_Data_Cleaning.R R script. This file was created after cleaning the initial mothers data and separating out the osmolarity values. It was saved to my thesis folder and now uploaded to the RMD file Savannah sent for cleaning the osmolarity values. Using this script, I will remove any outliers in the osmolarity data and create just one osmolarity value per individual per date and a mean of the values that are NOT outliers. 

#Create a data frame called osml_reps_o by reading in the RDS file from the mother osmolarity data.
osml_reps_0 <- read_rds("./MotherOsmolality.RDS") 

#Creating a new df by selecting out all of the rep 1 values.
osml_reps_1 <- osml_reps_0 %>%
  dplyr::select(Indiv_ID, CEWL_Blood_Collect_Date, Date_Blood_Analyzed, Plasma_Osmol_Rep = Plasma_Osmol_Rep1) %>%
  mutate(Rep = "1") 

#Creating a new df by selecting out all of the rep 2 values. 
osml_reps_2 <- osml_reps_0 %>%
  dplyr::select(Indiv_ID, CEWL_Blood_Collect_Date, Date_Blood_Analyzed, Plasma_Osmol_Rep = Plasma_Osmol_Rep2) %>%
  mutate(Rep = "2") 

#Creating a new df by selecting out all of the rep 3 values.
osml_reps_3 <- osml_reps_0 %>%
  dplyr::select(Indiv_ID, CEWL_Blood_Collect_Date, Date_Blood_Analyzed, Plasma_Osmol_Rep = Plasma_Osmol_Rep3) %>%
  mutate(Rep = "3") 

#Creating a new df by selecting out all of the rep 4 values
osml_reps_4 <- osml_reps_0 %>%
  dplyr::select(Indiv_ID, CEWL_Blood_Collect_Date, Date_Blood_Analyzed, Plasma_Osmol_Rep = Plasma_Osmol_Rep4) %>%
  mutate(Rep = "4") 

#Rbinding all of the previously made df together so that all of the technical osmolarity replicates are in once column. They have to be like this for the analysis. Then, filter out all of the replicates so the data frame only consists of the complete cases. The incomplete cases are from the blood samples that didn't have enough plasma to run multiple replicates. 
osml_reps <- osml_reps_1 %>%
  rbind(osml_reps_2) %>%
  rbind(osml_reps_3) %>%
  rbind(osml_reps_4) %>%
dplyr::filter(complete.cases(Plasma_Osmol_Rep))

#View a summary of the osml_reps to see that all of the reps are in the same column
summary(osml_reps)
```


```{r check n obs}

#THIS IS FROM SAVANNAH CHECKING SOMETHING! IRRELIVANT FOR NOW BUT LEAVING IN CASE I NEED TO CHECK SOMETHING 

# get ID's of the individuals that completed treatment
#individuals <- read.csv("./data/tmt_assignments.csv") %>%
 #dplyr::filter(conclusion == "complete") %>%
  #mutate(Indiv_ID = as.factor(Indiv_ID),
   #      conclusion = as.factor(conclusion))
#summary(individuals)

# calculate the number of dates for each individual
#osml_reps %>%
 # dplyr::filter(Indiv_ID %in% individuals$Indiv_ID) %>%
  #group_by(Indiv_ID, CEWL_Blood_Collect_Date) %>%
  #summarise(n()) %>%
  #group_by(Indiv_ID) %>%
  #summarise(n()) %>%
  #arrange(n())
```


# Replicates

Now, I will try to identify outliers within the replicates for a given individual on a given date. There must be at least 3 replicates to do this, so the first thing I need to do is figure out which individuals/dates have enough replicates, then subset my data to be only those individuals.


## Individuals with 3+ Replicates

```{r separate data w enough reps to assess}

# identify the individuals with at least 3-4 osmolarity reps
enuf_reps <- osml_reps %>%
  group_by(Indiv_ID, CEWL_Blood_Collect_Date) %>%
  mutate(count = n()) %>%
  dplyr::filter(count > 2) %>%
  arrange(count)
enuf_reps

# identify individuals with 1-2 reps
not_reps <- osml_reps %>%
  group_by(Indiv_ID, CEWL_Blood_Collect_Date) %>%
  mutate(count = n()) %>%
  dplyr::filter(count < 3) %>%
  arrange(count)
not_reps

# check that the total number of observations still add to original 340
nrow(enuf_reps) + nrow(not_reps)
nrow(enuf_reps) + nrow(not_reps) == nrow(osml_reps)

#yay it does add to 340
```


## Assess Variation

We want the Coefficient of Variation (CV) among our technical replicates to be small. We need to calculate it to identify whether there may be outliers.

```{r calculate CVs}

#creating a variable cv to determine if there may be outliers. 
CVs <- enuf_reps %>%
  group_by(Indiv_ID, CEWL_Blood_Collect_Date) %>%
  summarise(mean = mean(Plasma_Osmol_Rep),
            SD = sd(Plasma_Osmol_Rep),
            CV = (SD/mean) *100,
            min = min(Plasma_Osmol_Rep),
            max = max(Plasma_Osmol_Rep),
            range = max - min
            )
summary(CVs)
hist(CVs$CV)
hist(CVs$range) 

#The histograms look good. The values are mostly small. It looks like there are some outliers.
```

Ideally, CV would be 10-15%. If it's larger, and one of the replicates is very different than the others, we can assume that the replicates that are closer together are more reliable. 

## Find Outliers

```{r create find outlier function}
# write function to find outliers for each individual on each date
find_outliers <- function(df) {
  
  # initiate dataframe to compile info and list to compile plots
  outliers <- data.frame()
  #boxplots <- list()

  # initiate a for loop to go through every who in df
  for(indiv_ch in unique(df$Indiv_ID)) {
    
    # select data for only the individual of interest
    df_sub <- df %>%
      dplyr::filter(Indiv_ID == as.numeric(indiv_ch))
    
    # make a boxplot
    df_sub %>%
      ggplot(.) +
      geom_boxplot(aes(x = as.factor(CEWL_Blood_Collect_Date),
                       y = Plasma_Osmol_Rep,
                       fill = as.factor(CEWL_Blood_Collect_Date))) +
      ggtitle(paste("Individual", indiv_ch)) +
      theme_classic() -> plot
    
    stats <- ggplot_build(plot)$data[[1]] %>%
  mutate(x = as.numeric(x))
    
    # print/save
    print(plot)
    #boxplots[[indiv_ch]] <- plot
    
    # extract outliers
    outs <- df_sub %>%
      group_by(Indiv_ID, CEWL_Blood_Collect_Date) %>%
      summarise(n=n()) %>%
      arrange(CEWL_Blood_Collect_Date) %>%
      mutate(x = seq(1, nrow(.))) %>%
      left_join(stats) %>%
      select(Indiv_ID, CEWL_Blood_Collect_Date, outliers)
    
    # add to running dataframe of outliers
    outliers <- outliers %>%
      rbind(outs)
  }
  #return(boxplots)
  return(outliers)
}

```




Now apply the function to the data:

```{r find outlier using boxplots, fig.show="hold", out.width="50%"}

#Running this will give boxplots for each individual with each date that blood samples were run. It will visually show if there are any outliers. 
par(mfrow = c(71, 2))
outliers_found <- find_outliers(enuf_reps)
outliers_found
par(mfrow = c(1, 1))



outliers_found %>%
  filter(outliers != "numeric(0)")
  
unique(outliers_found$outliers)
```

## Remove Outliers

```{r remove outlier}


#enuf_reps_trimmed$outliers[[1]]

# filter out the one NA
enuf_reps_trimmed <- enuf_reps %>%
  left_join(outliers_found, by = c("Indiv_ID", "CEWL_Blood_Collect_Date")) %>%
  dplyr::filter(outliers %nin% c("NULL")) %>% 
  dplyr::filter((Plasma_Osmol_Rep != outliers | outliers == "numeric(0)"))
```

## Average Remaining Replicates

Now that the outliers are removed from the technical replicates when there were enough replicates to identify them, I will average the remaining replicates of the rejoined data for lizards with 1-2 and 3-4 replicates.

```{r calculate means}
osml_means <- not_reps %>%
  rbind(enuf_reps_trimmed) %>%
  group_by(CEWL_Blood_Collect_Date, Indiv_ID) %>%
  summarise(Plasma_Osmol_Rep_mean = mean(Plasma_Osmol_Rep))
```


# Export

```{r export cleaned}
saveRDS(osml_means, "/Users/robinbedard/Desktop/Thesis/clean_MotherOsmolality.RDS")
```









